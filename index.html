<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spreadsheet Merchants 3.0 - FPL Draft Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      min-height: 100vh;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .danger-overlay {
      background: linear-gradient(90deg, rgba(220, 38, 38, 0.15) 0%, rgba(220, 38, 38, 0.05) 100%);
    }
    
    .position-line {
      transition: stroke-width 0.2s, opacity 0.2s;
    }
    
    .position-line:hover {
      stroke-width: 4 !important;
      opacity: 1 !important;
    }
    
    .team-legend-item:hover .position-line {
      stroke-width: 4 !important;
      opacity: 1 !important;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    .tooltip {
      position: absolute;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }
  </style>
</head>
<body class="antialiased">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // Modern icon components
    const RefreshCw = ({ size = 20, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" className={className}>
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
      </svg>
    );
    
    const Settings = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v6m0 6v6"/>
        <path d="M12 12h9M3 12h9"/>
      </svg>
    );
    
    const TrendingUp = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
        <polyline points="17 6 23 6 23 12"/>
      </svg>
    );
    
    const Lock = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
    );

    function App() {
      const [config, setConfig] = useState({
        leagueId: '10991',
        userTeamId: '81877',
        password: 'merchants2026',
        leagueName: 'Spreadsheet Merchants 3.0'
      });
      
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [passwordInput, setPasswordInput] = useState('');
      const [showConfig, setShowConfig] = useState(false);
      const [leagueData, setLeagueData] = useState(null);
      const [standings, setStandings] = useState([]);
      const [allTransactions, setAllTransactions] = useState([]);
      const [transferAnalysis, setTransferAnalysis] = useState(null);
      const [analysisLoading, setAnalysisLoading] = useState(false);
      const [analysisProgress, setAnalysisProgress] = useState('');
      const [positionHistory, setPositionHistory] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [hoveredTeam, setHoveredTeam] = useState(null);
      const [selectedManager, setSelectedManager] = useState(null);
      const [benchData, setBenchData] = useState({});
      const [playerAnalysis, setPlayerAnalysis] = useState(null);
      const [analyzingPlayers, setAnalyzingPlayers] = useState(false);
      const [validationResults, setValidationResults] = useState(null);
      const [runningValidation, setRunningValidation] = useState(false);
      
      const svgRef = useRef(null);

      const analyzeAllPlayers = async () => {
        setAnalyzingPlayers(true);
        
        try {
          const apiBase = '/.netlify/functions/fpl-proxy?endpoint=';
          
          console.log('ðŸ”® Fetching comprehensive player data...');
          
          // Fetch bootstrap data (all players)
          const bootstrapResponse = await fetch(`${apiBase}/api/bootstrap-static`);
          const bootstrapData = await bootstrapResponse.json();
          
          // Fetch fixtures
          const fixturesResponse = await fetch(`${apiBase}/api/fixtures`);
          const fixturesData = await fixturesResponse.json();
          
          const teams = {};
          bootstrapData.teams.forEach(team => {
            teams[team.id] = team;
          });
          
          const positions = {1: 'GK', 2: 'DEF', 3: 'MID', 4: 'FWD'};
          
          // Get current gameweek
          const currentGW = bootstrapData.events.find(e => e.is_current)?.id || 
                           Math.max(...bootstrapData.events.filter(e => e.finished).map(e => e.id));
          
          const next5GWs = [currentGW + 1, currentGW + 2, currentGW + 3, currentGW + 4, currentGW + 5];
          
          console.log(`ðŸ“Š Analyzing GWs ${next5GWs.join(', ')}...`);
          
          // Build team fixtures map with attacking/defensive strength
          const teamFixtures = {};
          fixturesData.forEach(fixture => {
            if (next5GWs.includes(fixture.event)) {
              if (!teamFixtures[fixture.team_h]) teamFixtures[fixture.team_h] = [];
              if (!teamFixtures[fixture.team_a]) teamFixtures[fixture.team_a] = [];
              
              // Home team fixture
              teamFixtures[fixture.team_h].push({
                gw: fixture.event,
                opponent: fixture.team_a,
                isHome: true,
                oppDefStrength: teams[fixture.team_a].strength_defence_away,
                oppAttStrength: teams[fixture.team_a].strength_attack_away,
                teamAttStrength: teams[fixture.team_h].strength_attack_home,
                teamDefStrength: teams[fixture.team_h].strength_defence_home
              });
              
              // Away team fixture
              teamFixtures[fixture.team_a].push({
                gw: fixture.event,
                opponent: fixture.team_h,
                isHome: false,
                oppDefStrength: teams[fixture.team_h].strength_defence_home,
                oppAttStrength: teams[fixture.team_h].strength_attack_home,
                teamAttStrength: teams[fixture.team_a].strength_attack_away,
                teamDefStrength: teams[fixture.team_a].strength_defence_away
              });
            }
          });
          
          console.log('ðŸ§® Running advanced predictive model...');
          
          // Analyze each player with detailed probability model
          const analyzed = [];
          
          bootstrapData.elements.forEach(player => {
            // Must be available and have played
            if (player.status !== 'a' || player.minutes < 100) return;
            
            const teamId = player.team;
            const position = positions[player.element_type];
            const fixtures = teamFixtures[teamId] || [];
            
            if (fixtures.length < 5) return;
            
            // Extract player stats
            const totalMinutes = player.minutes;
            const gamesPlayed = totalMinutes / 90; // Approximate games
            const form = parseFloat(player.form || 0);
            const ppg = parseFloat(player.points_per_game || 0);
            const ownership = parseFloat(player.selected_by_percent || 0);
            
            // Historical rates (per 90 minutes equivalent)
            const goalsScored = player.goals_scored || 0;
            const assists = player.assists || 0;
            const cleanSheets = player.clean_sheets || 0;
            const bonusPoints = player.bonus || 0;
            const starts = player.starts || 0;
            
            // Calculate per-game probabilities
            const goalsPer90 = gamesPlayed > 0 ? (goalsScored / gamesPlayed) : 0;
            const assistsPer90 = gamesPlayed > 0 ? (assists / gamesPlayed) : 0;
            const cleanSheetRate = gamesPlayed > 0 ? (cleanSheets / gamesPlayed) : 0;
            const bonusRate = gamesPlayed > 0 ? (bonusPoints / gamesPlayed) : 0;
            const startRate = gamesPlayed > 0 ? (starts / gamesPlayed) : 0;
            
            // Calculate fixture-adjusted probabilities for next 5 GWs
            let totalExpectedPoints = 0;
            let avgGoalProb = 0;
            let avgAssistProb = 0;
            let avgCleanSheetProb = 0;
            let avgBonusProb = 0;
            let avgStartProb = startRate;
            
            fixtures.slice(0, 5).forEach(fixture => {
              // Attacking potential (goals & assists)
              const attackingDifficulty = fixture.oppDefStrength / 1000; // Normalize
              const attackingStrength = fixture.teamAttStrength / 1000;
              const attackMultiplier = (attackingStrength / attackingDifficulty);
              
              // Defensive potential (clean sheets)
              const defensiveDifficulty = fixture.oppAttStrength / 1000;
              const defensiveStrength = fixture.teamDefStrength / 1000;
              const defenseMultiplier = (defensiveStrength / defensiveDifficulty);
              
              // Home advantage
              const homeBonus = fixture.isHome ? 1.1 : 0.95;
              
              // Goals probability (position-weighted)
              const positionGoalWeight = {
                'FWD': 1.0,
                'MID': 0.85,
                'DEF': 0.3,
                'GK': 0.05
              }[position] || 0.5;
              
              const goalProb = Math.min(0.95, goalsPer90 * attackMultiplier * homeBonus * positionGoalWeight);
              
              // Assists probability
              const positionAssistWeight = {
                'FWD': 0.7,
                'MID': 1.0,
                'DEF': 0.4,
                'GK': 0.05
              }[position] || 0.5;
              
              const assistProb = Math.min(0.85, assistsPer90 * attackMultiplier * homeBonus * positionAssistWeight);
              
              // Clean sheet probability (defenders & keepers)
              const positionCSWeight = {
                'GK': 1.0,
                'DEF': 1.0,
                'MID': 0.0,
                'FWD': 0.0
              }[position] || 0;
              
              const cleanSheetProb = Math.min(0.75, cleanSheetRate * defenseMultiplier * homeBonus * positionCSWeight);
              
              // Bonus probability (form-based)
              const bonusProb = Math.min(0.6, bonusRate * (form / 5) * homeBonus);
              
              // Points calculation for this fixture
              let fixtureExpectedPoints = 2; // Base points for playing
              
              // Goals (FWD: 4pts, MID: 5pts, DEF: 6pts, GK: 6pts)
              const goalPoints = {'FWD': 4, 'MID': 5, 'DEF': 6, 'GK': 6}[position] || 4;
              fixtureExpectedPoints += goalProb * goalPoints;
              
              // Multiple goals bonus (if goal prob > 0.3, chance of 2nd goal)
              if (goalProb > 0.3) {
                fixtureExpectedPoints += (goalProb * 0.4) * goalPoints;
              }
              
              // Assists (3 pts each)
              fixtureExpectedPoints += assistProb * 3;
              
              // Clean sheet (DEF/GK: 4pts, MID: 1pt)
              const csPoints = {'GK': 4, 'DEF': 4, 'MID': 1, 'FWD': 0}[position] || 0;
              fixtureExpectedPoints += cleanSheetProb * csPoints;
              
              // Bonus points (average 1-3 when received)
              fixtureExpectedPoints += bonusProb * 2;
              
              // Playing time (60min: 1pt, 90min: 2pts)
              fixtureExpectedPoints *= avgStartProb;
              
              // Defensive contributions (tackles, clearances, saves) - estimate
              if (position === 'DEF' || position === 'GK') {
                // Assume ~0.5 extra points per game from defensive actions
                fixtureExpectedPoints += 0.5 * defenseMultiplier;
              }
              
              totalExpectedPoints += fixtureExpectedPoints;
              avgGoalProb += goalProb;
              avgAssistProb += assistProb;
              avgCleanSheetProb += cleanSheetProb;
              avgBonusProb += bonusProb;
            });
            
            // Average probabilities across 5 fixtures
            avgGoalProb /= 5;
            avgAssistProb /= 5;
            avgCleanSheetProb /= 5;
            avgBonusProb /= 5;
            
            analyzed.push({
              name: player.web_name,
              fullName: `${player.first_name} ${player.second_name}`,
              team: teams[teamId].short_name,
              position: position,
              totalPoints: player.total_points,
              form: form,
              ppg: ppg,
              minutes: player.minutes,
              ownership: ownership,
              
              // Historical stats
              goalsScored: goalsScored,
              assists: assists,
              cleanSheets: cleanSheets,
              bonusPoints: bonusPoints,
              
              // Probabilities (%)
              goalProbability: (avgGoalProb * 100),
              assistProbability: (avgAssistProb * 100),
              cleanSheetProbability: (avgCleanSheetProb * 100),
              bonusProbability: (avgBonusProb * 100),
              startProbability: (avgStartProb * 100),
              
              fixtures: fixtures.slice(0, 5).map(f => 
                `${teams[f.opponent].short_name}${f.isHome ? '(H)' : '(A)'}`
              ),
              
              expectedPoints: totalExpectedPoints,
              
              // Confidence score (0-100)
              confidence: Math.min(100, (
                (startRate * 50) + // Starting regularly is key
                (gamesPlayed > 10 ? 30 : gamesPlayed * 3) + // Sample size
                (form > 3 ? 20 : form * 6.67) // Current form
              ))
            });
          });
          
          // Sort by expected points
          analyzed.sort((a, b) => b.expectedPoints - a.expectedPoints);
          
          console.log(`âœ… Analyzed ${analyzed.length} players`);
          
          setPlayerAnalysis({
            currentGW,
            next5GWs,
            allPlayers: analyzed,
            top50: analyzed.slice(0, 50),
            byPosition: {
              FWD: analyzed.filter(p => p.position === 'FWD').slice(0, 15),
              MID: analyzed.filter(p => p.position === 'MID').slice(0, 15),
              DEF: analyzed.filter(p => p.position === 'DEF').slice(0, 15),
              GK: analyzed.filter(p => p.position === 'GK').slice(0, 10)
            },
            hiddenGems: analyzed.filter(p => p.ownership < 30).slice(0, 20),
            
            // Category leaders
            mostLikelyToScore: analyzed.slice().sort((a, b) => b.goalProbability - a.goalProbability).slice(0, 10),
            mostLikelyToAssist: analyzed.slice().sort((a, b) => b.assistProbability - a.assistProbability).slice(0, 10),
            bestCleanSheetOdds: analyzed.slice().sort((a, b) => b.cleanSheetProbability - a.cleanSheetProbability).slice(0, 10),
            bonusMagnets: analyzed.slice().sort((a, b) => b.bonusProbability - a.bonusProbability).slice(0, 10)
          });
          
        } catch (error) {
          console.error('Player analysis error:', error);
          alert('Failed to analyze players: ' + error.message);
        } finally {
          setAnalyzingPlayers(false);
        }
      };

      useEffect(() => {
        const saved = localStorage.getItem('fpl-config');
        if (saved) {
          setConfig(JSON.parse(saved));
        }
        const auth = localStorage.getItem('fpl-auth');
        if (auth === 'true') {
          setIsAuthenticated(true);
        }
      }, []);

      useEffect(() => {
        if (isAuthenticated && config.leagueId) {
          fetchLeagueData();
        }
      }, [isAuthenticated]);

      const handleLogin = () => {
        if (passwordInput === config.password) {
          setIsAuthenticated(true);
          localStorage.setItem('fpl-auth', 'true');
        } else {
          alert('Incorrect password');
        }
      };

      const fetchLeagueData = async () => {
        setLoading(true);
        setError(null);
        
        try {
          const apiBase = '/.netlify/functions/fpl-proxy?endpoint=';
          
          const leagueResponse = await fetch(`${apiBase}/api/league/${config.leagueId}/details`);
          if (!leagueResponse.ok) {
            throw new Error(`Failed to fetch league details`);
          }
          const league = await leagueResponse.json();
          
          setLeagueData(league);

          if (league.standings && league.league_entries) {
            const standingsWithDetails = league.standings.map(standing => {
              const entry = league.league_entries.find(e => e.id === standing.league_entry);
              return {
                ...standing,
                entry_id: entry?.entry_id,
                entry_name: entry?.entry_name || `${entry?.player_first_name || ''} ${entry?.player_last_name || ''}`.trim(),
                player_name: `${entry?.player_first_name || ''} ${entry?.player_last_name || ''}`.trim(),
                player_first_name: entry?.player_first_name || '',
                player_last_name: entry?.player_last_name || ''
              };
            });
            setStandings(standingsWithDetails.sort((a, b) => a.rank - b.rank));
          }
          
          if (league.league_entries) {
            await buildPositionHistory(league.league_entries, apiBase, league);
            await fetchAllTransactions(league.league_entries, apiBase, league);
          }

          setLastUpdated(new Date());
        } catch (err) {
          setError(err.message);
          console.error('Error fetching data:', err);
        } finally {
          setLoading(false);
        }
      };

      const buildPositionHistory = async (leagueEntries, apiBase, league) => {
        try {
          const currentGW = league?.league?.current_event || 22;
          const cached = localStorage.getItem('position-history-cache');
          
          if (cached) {
            const cachedData = JSON.parse(cached);
            if (cachedData.history && cachedData.history.length === 0) {
              localStorage.removeItem('position-history-cache');
            } else if (cachedData.gameweek === currentGW && cachedData.timestamp > Date.now() - 86400000) {
              setPositionHistory(cachedData.history);
              return;
            }
          }
          
          const history = [];
          const teamHistories = [];
          
          for (const entry of leagueEntries) {
            try {
              const response = await fetch(`${apiBase}/api/entry/${entry.entry_id}/history`);
              if (!response.ok) continue;
              
              const data = await response.json();
              teamHistories.push({
                entry_id: entry.entry_id,
                entry_name: entry.entry_name,
                player_first_name: entry.player_first_name,
                player_last_name: entry.player_last_name,
                history: data.history || []
              });
              
              await new Promise(resolve => setTimeout(resolve, 100));
            } catch (e) {
              console.log(`Error fetching team ${entry.entry_id}:`, e);
            }
          }
          
          for (let gw = 1; gw <= currentGW; gw++) {
            const gwStandings = [];
            
            teamHistories.forEach(team => {
              const gwData = team.history.find(h => h.event === gw);
              
              if (gwData) {
                gwStandings.push({
                  entry_id: team.entry_id,
                  entry_name: team.entry_name,
                  player_first_name: team.player_first_name,
                  player_last_name: team.player_last_name,
                  total_points: gwData.total_points,
                  gw_points: gwData.points
                });
              }
            });
            
            gwStandings.sort((a, b) => b.total_points - a.total_points);
            
            gwStandings.forEach((team, index) => {
              history.push({
                gameweek: gw,
                entry_id: team.entry_id,
                entry_name: team.entry_name,
                player_first_name: team.player_first_name,
                player_last_name: team.player_last_name,
                position: index + 1,
                points: team.total_points
              });
            });
          }
          
          setPositionHistory(history);
          
          localStorage.setItem('position-history-cache', JSON.stringify({
            gameweek: currentGW,
            timestamp: Date.now(),
            history: history
          }));
          
        } catch (e) {
          console.log('Error building position history:', e);
        }
      };

      const fetchAllTransactions = async (leagueEntries, apiBase, league) => {
        const leagueId = league?.league?.id;
        if (!leagueId) return;

        try {
          const response = await fetch(`${apiBase}/api/draft/league/${leagueId}/transactions`);
          if (!response.ok) return;
          
          const data = await response.json();
          const transactions = data.transactions || [];
          
          setAllTransactions(transactions);
          
          const cached = localStorage.getItem('transfer-analysis-cache');
          
          if (cached) {
            const cachedData = JSON.parse(cached);
            const currentGW = leagueData?.current_event || 1;
            if (cachedData.gameweek === currentGW && cachedData.timestamp > Date.now() - 86400000) {
              setTransferAnalysis(cachedData.analysis);
              return;
            }
          }
          
          await analyzeTransfers(transactions, leagueEntries, apiBase, leagueId);
        } catch (e) {
          console.log('Error fetching transactions:', e);
        }
      };

      const analyzeTransfers = async (transactions, leagueEntries, apiBase, leagueId) => {
        setAnalysisLoading(true);
        
        try {
          setAnalysisProgress('Fetching player data...');
          
          const bootstrapResponse = await fetch(`${apiBase}/api/bootstrap-static`);
          const bootstrapData = await bootstrapResponse.json();
          
          const players = {};
          bootstrapData.elements.forEach(p => {
            players[p.id] = {
              name: p.web_name,
              team: p.team,
              position: p.element_type
            };
          });
          
          setAnalysisProgress('Analyzing transfers...');
          
          const teamImpact = {};
          leagueEntries.forEach(entry => {
            teamImpact[entry.entry_id] = {
              entry_name: entry.entry_name,
              player_name: `${entry.player_first_name} ${entry.player_last_name}`,
              totalImpact: 0,
              transferCount: 0,
              transfers: []
            };
          });
          
          const acceptedWaivers = transactions.filter(t => 
            t.kind === 'w' && 
            t.result === 'a' && 
            t.element_in && 
            t.element_out
          );
          
          acceptedWaivers.forEach(trans => {
            const playerIn = players[trans.element_in];
            const playerOut = players[trans.element_out];
            const gwPicked = trans.event;
            
            if (playerIn && playerOut) {
              teamImpact[trans.entry].transferCount++;
              teamImpact[trans.entry].transfers.push({
                gw: gwPicked,
                playerIn: playerIn.name,
                playerOut: playerOut.name
              });
            }
          });
          
          const impactArray = Object.values(teamImpact)
            .filter(t => t.transferCount > 0)
            .sort((a, b) => b.totalImpact - a.totalImpact);
          
          const avgArray = impactArray
            .map(t => ({
              ...t,
              avgImpact: t.transferCount > 0 ? t.totalImpact / t.transferCount : 0
            }))
            .sort((a, b) => b.avgImpact - a.avgImpact);
          
          setTransferAnalysis({
            byTotal: impactArray,
            byAverage: avgArray
          });
          
          const currentGW = leagueData?.current_event || 1;
          localStorage.setItem('transfer-analysis-cache', JSON.stringify({
            gameweek: currentGW,
            timestamp: Date.now(),
            analysis: {
              byTotal: impactArray,
              byAverage: avgArray
            }
          }));
          
        } catch (e) {
          console.error('Analysis error:', e);
        } finally {
          setAnalysisLoading(false);
          setAnalysisProgress('');
        }
      };

      const analyzeTransfers = async (transactions, leagueEntries, apiBase, leagueId) => {
        setAnalysisLoading(true);
        
        try {
          setAnalysisProgress('Fetching player data...');
          
          const bootstrapResponse = await fetch(`${apiBase}/api/bootstrap-static`);
          const bootstrapData = await bootstrapResponse.json();
          
          const players = {};
          bootstrapData.elements.forEach(p => {
            players[p.id] = {
              name: p.web_name,
              team: p.team,
              position: p.element_type
            };
          });
          
          setAnalysisProgress('Analyzing transfers and calculating impact...');
          
          // Fetch detailed history for bench point calculations
          const teamHistories = {};
          for (const entry of leagueEntries) {
            try {
              const response = await fetch(`${apiBase}/api/entry/${entry.entry_id}/history`);
              if (response.ok) {
                const data = await response.json();
                teamHistories[entry.entry_id] = data.history || [];
              }
              await new Promise(resolve => setTimeout(resolve, 100));
            } catch (e) {
              console.log('Error fetching history:', e);
            }
          }
          
          const teamImpact = {};
          leagueEntries.forEach(entry => {
            const history = teamHistories[entry.entry_id] || [];
            const totalBenchPoints = history.reduce((sum, h) => sum + (h.points_on_bench || 0), 0);
            
            teamImpact[entry.entry_id] = {
              entry_id: entry.entry_id,
              entry_name: entry.entry_name,
              player_name: `${entry.player_first_name} ${entry.player_last_name}`,
              totalImpact: 0,
              transferCount: 0,
              transfers: [],
              bestTransfer: null,
              worstTransfer: null,
              totalBenchPoints: totalBenchPoints,
              avgBenchPoints: history.length > 0 ? (totalBenchPoints / history.length).toFixed(1) : 0
            };
          });
          
          const acceptedWaivers = transactions.filter(t => 
            t.kind === 'w' && 
            t.result === 'a' && 
            t.element_in && 
            t.element_out
          );
          
          console.log(`Analyzing ${acceptedWaivers.length} transfers...`);
          
          acceptedWaivers.forEach(trans => {
            const playerIn = players[trans.element_in];
            const playerOut = players[trans.element_out];
            const gwPicked = trans.event;
            
            if (playerIn && playerOut) {
              // Track individual transfer for details
              const transferDetail = {
                gw: gwPicked,
                playerIn: playerIn.name,
                playerOut: playerOut.name,
                impact: 0 // Would need detailed GW scoring to calculate
              };
              
              teamImpact[trans.entry].transferCount++;
              teamImpact[trans.entry].transfers.push(transferDetail);
            }
          });
          
          // Calculate best/worst transfers (mock data - would need actual scoring)
          Object.values(teamImpact).forEach(team => {
            if (team.transfers.length > 0) {
              team.bestTransfer = team.transfers[0]; // Placeholder
              team.worstTransfer = team.transfers[team.transfers.length - 1]; // Placeholder
            }
          });
          
          const impactArray = Object.values(teamImpact)
            .sort((a, b) => b.totalImpact - a.totalImpact);
          
          const avgArray = impactArray
            .map(t => ({
              ...t,
              avgImpact: t.transferCount > 0 ? t.totalImpact / t.transferCount : 0
            }))
            .sort((a, b) => b.avgImpact - a.avgImpact);
          
          // Sort by bench points wasted
          const benchArray = [...impactArray]
            .sort((a, b) => b.totalBenchPoints - a.totalBenchPoints);
          
          setTransferAnalysis({
            byTotal: impactArray,
            byAverage: avgArray,
            byBenchPoints: benchArray,
            totalTransfers: acceptedWaivers.length
          });
          
          setBenchData(teamHistories);
          
          const currentGW = leagueData?.current_event || 1;
          localStorage.setItem('transfer-analysis-cache', JSON.stringify({
            gameweek: currentGW,
            timestamp: Date.now(),
            analysis: {
              byTotal: impactArray,
              byAverage: avgArray,
              byBenchPoints: benchArray,
              totalTransfers: acceptedWaivers.length
            }
          }));
          
        } catch (e) {
          console.error('Analysis error:', e);
        } finally {
          setAnalysisLoading(false);
          setAnalysisProgress('');
        }
      };

      const validateModel = async () => {
        setRunningValidation(true);
        
        try {
          const apiBase = '/.netlify/functions/fpl-proxy?endpoint=';
          
          console.log('ðŸ§ª Running comprehensive model validation...');
          
          // Fetch data
          const bootstrapResponse = await fetch(`${apiBase}/api/bootstrap-static`);
          const bootstrapData = await bootstrapResponse.json();
          
          const fixturesResponse = await fetch(`${apiBase}/api/fixtures`);
          const fixturesData = await fixturesResponse.json();
          
          const teams = {};
          bootstrapData.teams.forEach(team => teams[team.id] = team);
          
          const positions = {1: 'GK', 2: 'DEF', 3: 'MID', 4: 'FWD'};
          
          // Get ALL completed gameweeks
          const currentGW = bootstrapData.events.find(e => e.is_current)?.id || 
                           Math.max(...bootstrapData.events.filter(e => e.finished).map(e => e.id));
          
          const completedGWs = bootstrapData.events
            .filter(e => e.finished)
            .map(e => e.id);
          
          console.log(`ðŸ“Š Testing against ALL ${completedGWs.length} completed gameweeks...`);
          
          // Build fixtures map for ALL completed games
          const allFixtures = {};
          fixturesData.forEach(fixture => {
            if (completedGWs.includes(fixture.event) && fixture.finished) {
              if (!allFixtures[fixture.team_h]) allFixtures[fixture.team_h] = [];
              if (!allFixtures[fixture.team_a]) allFixtures[fixture.team_a] = [];
              
              allFixtures[fixture.team_h].push({
                gw: fixture.event,
                opponent: fixture.team_a,
                isHome: true,
                oppDefStrength: teams[fixture.team_a].strength_defence_away,
                oppAttStrength: teams[fixture.team_a].strength_attack_away,
                teamAttStrength: teams[fixture.team_h].strength_attack_home,
                teamDefStrength: teams[fixture.team_h].strength_defence_home,
                finished: true
              });
              
              allFixtures[fixture.team_a].push({
                gw: fixture.event,
                opponent: fixture.team_h,
                isHome: false,
                oppDefStrength: teams[fixture.team_h].strength_defence_home,
                oppAttStrength: teams[fixture.team_h].strength_attack_home,
                teamAttStrength: teams[fixture.team_a].strength_attack_away,
                teamDefStrength: teams[fixture.team_a].strength_defence_away,
                finished: true
              });
            }
          });
          
          console.log('ðŸ” Testing multiple parameter configurations...');
          
          // Test different parameter sets to find optimal weights
          const parameterTests = [
            // Current model
            { name: 'Current', goalWeight: 1.0, assistWeight: 1.0, homeBonus: 1.1, formWeight: 1.0 },
            // More conservative
            { name: 'Conservative', goalWeight: 0.8, assistWeight: 0.8, homeBonus: 1.05, formWeight: 0.8 },
            // More aggressive
            { name: 'Aggressive', goalWeight: 1.2, assistWeight: 1.2, homeBonus: 1.15, formWeight: 1.2 },
            // Form-focused
            { name: 'Form-Focused', goalWeight: 1.0, assistWeight: 1.0, homeBonus: 1.1, formWeight: 1.5 },
            // Home-advantage focused
            { name: 'Home-Heavy', goalWeight: 1.0, assistWeight: 1.0, homeBonus: 1.2, formWeight: 1.0 }
          ];
          
          const parameterResults = [];
          
          for (const params of parameterTests) {
            console.log(`Testing ${params.name} parameters...`);
            
            const validationData = [];
            const testPlayers = bootstrapData.elements
              .filter(p => p.status === 'a' && p.minutes >= 450 && p.starts >= 5)
              .slice(0, 150); // Test more players with full season data
            
            for (const player of testPlayers) {
              try {
                const teamId = player.team;
                const position = positions[player.element_type];
                const fixtures = (allFixtures[teamId] || []).filter(f => f.finished);
                
                if (fixtures.length < 5) continue;
                
                // Calculate baseline stats (per 90)
                const totalMinutes = player.minutes;
                const gamesPlayed = totalMinutes / 90;
                
                const goalsScored = player.goals_scored || 0;
                const assists = player.assists || 0;
                const cleanSheets = player.clean_sheets || 0;
                const bonusPoints = player.bonus || 0;
                const starts = player.starts || 0;
                
                const goalsPer90 = gamesPlayed > 0 ? (goalsScored / gamesPlayed) : 0;
                const assistsPer90 = gamesPlayed > 0 ? (assists / gamesPlayed) : 0;
                const cleanSheetRate = gamesPlayed > 0 ? (cleanSheets / gamesPlayed) : 0;
                const bonusRate = gamesPlayed > 0 ? (bonusPoints / gamesPlayed) : 0;
                const startRate = gamesPlayed > 0 ? (starts / gamesPlayed) : 0;
                
                const form = parseFloat(player.form || 0);
                
                // Actual season totals
                const actualPoints = player.total_points;
                const actualGoals = goalsScored;
                const actualAssists = assists;
                const actualCleanSheets = cleanSheets;
                
                // Run prediction with current parameter set
                let predictedPoints = 0;
                let predictedGoals = 0;
                let predictedAssists = 0;
                
                fixtures.forEach(fixture => {
                  const attackingDifficulty = fixture.oppDefStrength / 1000;
                  const attackingStrength = fixture.teamAttStrength / 1000;
                  const attackMultiplier = (attackingStrength / attackingDifficulty) * params.goalWeight;
                  
                  const defensiveDifficulty = fixture.oppAttStrength / 1000;
                  const defensiveStrength = fixture.teamDefStrength / 1000;
                  const defenseMultiplier = defensiveStrength / defensiveDifficulty;
                  
                  const homeBonus = fixture.isHome ? params.homeBonus : 0.95;
                  const formMultiplier = (form / 5) * params.formWeight;
                  
                  const positionGoalWeight = {'FWD': 1.0, 'MID': 0.85, 'DEF': 0.3, 'GK': 0.05}[position] || 0.5;
                  const goalProb = Math.min(0.95, goalsPer90 * attackMultiplier * homeBonus * positionGoalWeight);
                  
                  const positionAssistWeight = {'FWD': 0.7, 'MID': 1.0, 'DEF': 0.4, 'GK': 0.05}[position] || 0.5;
                  const assistProb = Math.min(0.85, assistsPer90 * attackMultiplier * homeBonus * positionAssistWeight * params.assistWeight);
                  
                  const positionCSWeight = {'GK': 1.0, 'DEF': 1.0, 'MID': 0.0, 'FWD': 0.0}[position] || 0;
                  const cleanSheetProb = Math.min(0.75, cleanSheetRate * defenseMultiplier * homeBonus * positionCSWeight);
                  
                  const bonusProb = Math.min(0.6, bonusRate * formMultiplier * homeBonus);
                  
                  predictedGoals += goalProb;
                  predictedAssists += assistProb;
                  
                  let fixturePoints = 2;
                  const goalPoints = {'FWD': 4, 'MID': 5, 'DEF': 6, 'GK': 6}[position] || 4;
                  fixturePoints += goalProb * goalPoints;
                  if (goalProb > 0.3) fixturePoints += (goalProb * 0.4) * goalPoints;
                  fixturePoints += assistProb * 3;
                  const csPoints = {'GK': 4, 'DEF': 4, 'MID': 1, 'FWD': 0}[position] || 0;
                  fixturePoints += cleanSheetProb * csPoints;
                  fixturePoints += bonusProb * 2;
                  fixturePoints *= startRate;
                  if (position === 'DEF' || position === 'GK') {
                    fixturePoints += 0.5 * defenseMultiplier;
                  }
                  
                  predictedPoints += fixturePoints;
                });
                
                const pointsError = Math.abs(predictedPoints - actualPoints);
                const goalsError = Math.abs(predictedGoals - actualGoals);
                const assistsError = Math.abs(predictedAssists - actualAssists);
                
                validationData.push({
                  name: player.web_name,
                  team: teams[teamId].short_name,
                  position: position,
                  predicted: { points: predictedPoints, goals: predictedGoals, assists: predictedAssists },
                  actual: { points: actualPoints, goals: actualGoals, assists: actualAssists },
                  errors: { points: pointsError, goals: goalsError, assists: assistsError },
                  percentError: actualPoints > 0 ? (pointsError / actualPoints * 100) : 0
                });
                
              } catch (e) {
                console.log('Error:', e);
              }
            }
            
            if (validationData.length > 0) {
              const avgError = validationData.reduce((sum, p) => sum + p.errors.points, 0) / validationData.length;
              const rmse = Math.sqrt(validationData.reduce((sum, p) => sum + Math.pow(p.errors.points, 2), 0) / validationData.length);
              const avgGoalsError = validationData.reduce((sum, p) => sum + p.errors.goals, 0) / validationData.length;
              const avgAssistsError = validationData.reduce((sum, p) => sum + p.errors.assists, 0) / validationData.length;
              
              parameterResults.push({
                ...params,
                avgError,
                rmse,
                avgGoalsError,
                avgAssistsError,
                validationData
              });
            }
            
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          // Find best parameter set
          parameterResults.sort((a, b) => a.avgError - b.avgError);
          const bestParams = parameterResults[0];
          
          console.log(`âœ… Best configuration: ${bestParams.name} (Â±${bestParams.avgError.toFixed(2)} pts error)`);
          
          const biggestMisses = [...bestParams.validationData]
            .sort((a, b) => b.errors.points - a.errors.points)
            .slice(0, 20);
          
          const bestPredictions = [...bestParams.validationData]
            .sort((a, b) => a.errors.points - b.errors.points)
            .slice(0, 20);
          
          // By position breakdown
          const byPosition = {};
          ['FWD', 'MID', 'DEF', 'GK'].forEach(pos => {
            const posPlayers = bestParams.validationData.filter(p => p.position === pos);
            if (posPlayers.length > 0) {
              byPosition[pos] = {
                count: posPlayers.length,
                avgError: posPlayers.reduce((sum, p) => sum + p.errors.points, 0) / posPlayers.length,
                avgGoalsError: posPlayers.reduce((sum, p) => sum + p.errors.goals, 0) / posPlayers.length,
                avgAssistsError: posPlayers.reduce((sum, p) => sum + p.errors.assists, 0) / posPlayers.length
              };
            }
          });
          
          setValidationResults({
            testPeriod: `GW1-${currentGW-1} (${completedGWs.length} gameweeks)`,
            playersValidated: bestParams.validationData.length,
            optimalParameters: {
              name: bestParams.name,
              goalWeight: bestParams.goalWeight,
              assistWeight: bestParams.assistWeight,
              homeBonus: bestParams.homeBonus,
              formWeight: bestParams.formWeight
            },
            allParameterTests: parameterResults.map(p => ({
              name: p.name,
              avgError: p.avgError,
              rmse: p.rmse
            })),
            metrics: {
              avgPointsError: bestParams.avgError,
              avgGoalsError: bestParams.avgGoalsError,
              avgAssistsError: bestParams.avgAssistsError,
              rmse: bestParams.rmse
            },
            byPosition: byPosition,
            biggestMisses: biggestMisses,
            bestPredictions: bestPredictions,
            allResults: bestParams.validationData
          });
          
        } catch (error) {
          console.error('Validation error:', error);
          alert('Validation failed: ' + error.message);
        } finally {
          setRunningValidation(false);
        }
      };

      // Position History Chart Component
      const PositionChart = () => {
        if (positionHistory.length === 0) return null;
        
        const maxGW = Math.max(...positionHistory.map(h => h.gameweek));
        const colors = [
          '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#06b6d4', '#ef4444',
          '#ec4899', '#14b8a6', '#f97316', '#84cc16', '#a855f7', '#fb923c'
        ];
        
        const chartWidth = 1000;
        const chartHeight = 500;
        const padding = { top: 40, right: 120, bottom: 60, left: 60 };
        const plotWidth = chartWidth - padding.left - padding.right;
        const plotHeight = chartHeight - padding.top - padding.bottom;
        
        return (
          <div className="relative">
            <svg 
              ref={svgRef}
              width="100%" 
              height={chartHeight} 
              viewBox={`0 0 ${chartWidth} ${chartHeight}`}
              className="overflow-visible"
            >
              {/* Background danger zones */}
              <defs>
                <pattern id="dangerPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                  <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" stroke="#ef4444" strokeWidth="0.5" opacity="0.1"/>
                </pattern>
              </defs>
              
              {/* Danger zone backgrounds */}
              {[7, 8, 10, 11, 12].map(pos => (
                <rect
                  key={pos}
                  x={padding.left}
                  y={padding.top + (pos - 1) * (plotHeight / 12)}
                  width={plotWidth}
                  height={plotHeight / 12}
                  fill="url(#dangerPattern)"
                  opacity="0.3"
                />
              ))}
              
              {/* Grid lines */}
              {Array.from({length: 13}, (_, i) => i).map(pos => (
                <g key={pos}>
                  <line
                    x1={padding.left}
                    y1={padding.top + pos * (plotHeight / 12)}
                    x2={chartWidth - padding.right}
                    y2={padding.top + pos * (plotHeight / 12)}
                    stroke="rgba(255, 255, 255, 0.1)"
                    strokeWidth={pos === 0 || pos === 6 || pos === 9 || pos === 12 ? "2" : "1"}
                  />
                  {pos < 12 && (
                    <text
                      x={padding.left - 15}
                      y={padding.top + pos * (plotHeight / 12) + (plotHeight / 24)}
                      fill="rgba(255, 255, 255, 0.5)"
                      fontSize="12"
                      textAnchor="end"
                      dominantBaseline="middle"
                    >
                      {pos + 1}
                    </text>
                  )}
                </g>
              ))}
              
              {/* Gameweek labels */}
              {Array.from({length: maxGW}, (_, i) => i + 1).filter(gw => gw % 2 === 1).map(gw => (
                <text
                  key={gw}
                  x={padding.left + ((gw - 1) / maxGW) * plotWidth}
                  y={chartHeight - padding.bottom + 25}
                  fill="rgba(255, 255, 255, 0.5)"
                  fontSize="11"
                  textAnchor="middle"
                >
                  GW{gw}
                </text>
              ))}
              
              {/* Team lines */}
              {standings.map((team, idx) => {
                const teamHistory = positionHistory
                  .filter(h => h.entry_id === team.entry_id)
                  .sort((a, b) => a.gameweek - b.gameweek);
                
                if (teamHistory.length === 0) return null;
                
                const color = colors[idx % colors.length];
                const isHovered = hoveredTeam === team.entry_id;
                
                const points = teamHistory.map(h => ({
                  x: padding.left + ((h.gameweek - 1) / maxGW) * plotWidth,
                  y: padding.top + (h.position - 0.5) * (plotHeight / 12),
                  gw: h.gameweek,
                  pos: h.position,
                  points: h.points,
                  inDanger: [7, 8, 10, 11, 12].includes(h.position)
                }));
                
                // Create path
                const pathD = points.map((p, i) => 
                  `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
                ).join(' ');
                
                return (
                  <g 
                    key={team.entry_id}
                    className="team-line-group"
                    onMouseEnter={() => setHoveredTeam(team.entry_id)}
                    onMouseLeave={() => setHoveredTeam(null)}
                  >
                    {/* Glow effect when hovered */}
                    {isHovered && (
                      <path
                        d={pathD}
                        stroke={color}
                        strokeWidth="8"
                        fill="none"
                        opacity="0.2"
                        filter="blur(4px)"
                      />
                    )}
                    
                    {/* Main line */}
                    <path
                      d={pathD}
                      stroke={color}
                      strokeWidth={isHovered ? "3" : "2"}
                      fill="none"
                      opacity={hoveredTeam === null || isHovered ? "0.9" : "0.2"}
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      className="position-line transition-all duration-200"
                    />
                    
                    {/* Data points */}
                    {points.map((point, i) => (
                      <circle
                        key={i}
                        cx={point.x}
                        cy={point.y}
                        r={isHovered ? "5" : "3"}
                        fill={point.inDanger ? "#ef4444" : color}
                        stroke="white"
                        strokeWidth="1.5"
                        opacity={hoveredTeam === null || isHovered ? "1" : "0.3"}
                        className="transition-all duration-200"
                      >
                        <title>
                          {team.player_first_name} {team.player_last_name}
                          {'\n'}GW{point.gw}: P{point.pos} ({point.points} pts)
                        </title>
                      </circle>
                    ))}
                    
                    {/* Name label at end */}
                    {isHovered && points.length > 0 && (
                      <text
                        x={points[points.length - 1].x + 10}
                        y={points[points.length - 1].y}
                        fill={color}
                        fontSize="13"
                        fontWeight="600"
                        dominantBaseline="middle"
                      >
                        {team.player_first_name} {team.player_last_name}
                      </text>
                    )}
                  </g>
                );
              })}
              
              {/* Axis labels */}
              <text
                x={padding.left - 45}
                y={chartHeight / 2}
                fill="rgba(255, 255, 255, 0.6)"
                fontSize="12"
                fontWeight="500"
                textAnchor="middle"
                transform={`rotate(-90, ${padding.left - 45}, ${chartHeight / 2})`}
              >
                Position
              </text>
              
              <text
                x={chartWidth / 2}
                y={chartHeight - 10}
                fill="rgba(255, 255, 255, 0.6)"
                fontSize="12"
                fontWeight="500"
                textAnchor="middle"
              >
                Gameweek
              </text>
            </svg>
            
            {/* Legend */}
            <div className="mt-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              {standings.map((team, idx) => (
                <div
                  key={team.entry_id}
                  className="team-legend-item flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all hover:bg-white/5"
                  onMouseEnter={() => setHoveredTeam(team.entry_id)}
                  onMouseLeave={() => setHoveredTeam(null)}
                  style={{
                    opacity: hoveredTeam === null || hoveredTeam === team.entry_id ? 1 : 0.4,
                    transform: hoveredTeam === team.entry_id ? 'scale(1.05)' : 'scale(1)'
                  }}
                >
                  <div 
                    style={{ 
                      width: '14px', 
                      height: '14px', 
                      backgroundColor: colors[idx % colors.length],
                      borderRadius: '50%',
                      boxShadow: hoveredTeam === team.entry_id ? `0 0 8px ${colors[idx % colors.length]}` : 'none'
                    }} 
                  />
                  <span className="text-white/80 text-sm font-medium truncate">
                    {team.player_first_name} {team.player_last_name}
                  </span>
                </div>
              ))}
            </div>
            
            <p className="text-white/40 text-xs mt-6 text-center">
              ðŸ”´ Red dots indicate time spent in danger zone (positions 7, 8, 10, 11, 12) â€¢ Hover over lines to highlight
            </p>
          </div>
        );
      };

      if (!isAuthenticated) {
        return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="glass-card rounded-2xl p-8 max-w-md w-full shadow-2xl">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">ðŸ”</div>
                <h1 className="text-3xl font-bold text-white mb-2">
                  Spreadsheet Merchants
                </h1>
                <p className="text-white/60">FPL Draft League Tracker</p>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-white/80 text-sm font-medium mb-2">
                    Password
                  </label>
                  <div className="relative">
                    <Lock className="absolute left-3 top-3 text-white/40" size={20} />
                    <input
                      type="password"
                      value={passwordInput}
                      onChange={(e) => setPasswordInput(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      className="w-full pl-11 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-yellow-400/50 focus:ring-2 focus:ring-yellow-400/20"
                      placeholder="Enter league password"
                    />
                  </div>
                </div>
                
                <button
                  onClick={handleLogin}
                  className="w-full py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-semibold rounded-xl hover:from-yellow-300 hover:to-yellow-400 transition-all shadow-lg hover:shadow-yellow-400/50"
                >
                  Access League
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="sticky top-0 z-50 glass-card border-b border-white/10">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="text-4xl">ðŸ”</div>
                  <div>
                    <h1 className="text-2xl font-bold text-white">
                      {config.leagueName}
                    </h1>
                    <p className="text-sm text-white/50">
                      {lastUpdated && `Updated ${lastUpdated.toLocaleTimeString()}`}
                      <span className="ml-2 text-yellow-400/60">â€¢ Cached 24h</span>
                    </p>
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  <button
                    onClick={validateModel}
                    disabled={runningValidation}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                      runningValidation
                        ? 'bg-orange-500/20 text-orange-400 cursor-not-allowed'
                        : 'bg-orange-500/30 text-orange-300 hover:bg-orange-500/40 border border-orange-500/50'
                    }`}
                  >
                    <span className="text-xl">{runningValidation ? 'â³' : 'ðŸ§ª'}</span>
                    <span className="hidden sm:inline">
                      {runningValidation ? 'Validating...' : 'Validate Model'}
                    </span>
                  </button>
                  
                  <button
                    onClick={analyzeAllPlayers}
                    disabled={analyzingPlayers}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                      analyzingPlayers
                        ? 'bg-purple-500/20 text-purple-400 cursor-not-allowed'
                        : 'bg-purple-500/30 text-purple-300 hover:bg-purple-500/40 border border-purple-500/50'
                    }`}
                  >
                    <span className="text-xl">{analyzingPlayers ? 'â³' : 'ðŸ”®'}</span>
                    <span className="hidden sm:inline">
                      {analyzingPlayers ? 'Analyzing...' : 'Player Analysis'}
                    </span>
                  </button>
                  
                  <button
                    onClick={fetchLeagueData}
                    disabled={loading}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                      loading 
                        ? 'bg-white/5 text-white/40 cursor-not-allowed' 
                        : 'bg-white/10 text-white hover:bg-white/20'
                    }`}
                  >
                    <RefreshCw size={18} className={loading ? 'animate-spin' : ''} />
                    <span className="hidden sm:inline">
                      {loading ? 'Loading...' : 'Refresh'}
                    </span>
                  </button>
                  
                  <button 
                    onClick={() => setShowConfig(true)}
                    className="flex items-center gap-2 px-4 py-2 rounded-lg font-medium bg-white/10 text-white hover:bg-white/20 transition-all"
                  >
                    <Settings size={18} />
                    <span className="hidden sm:inline">Settings</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-6 py-8 space-y-8">
            {error && (
              <div className="glass-card rounded-xl p-4 border-l-4 border-red-500">
                <p className="text-red-400 font-medium">Error: {error}</p>
              </div>
            )}

            {/* Validation Results */}
            {validationResults && (
              <div className="glass-card rounded-2xl p-8 fade-in border-2 border-orange-500/30">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <span className="text-4xl">ðŸ§ª</span>
                    <div>
                      <h2 className="text-2xl font-bold text-white">
                        Self-Tuning Model Validation
                      </h2>
                      <p className="text-sm text-white/50">
                        Tested on {validationResults.testPeriod} â€¢ {validationResults.playersValidated} players
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={() => setValidationResults(null)}
                    className="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-all text-sm"
                  >
                    Close
                  </button>
                </div>

                {/* Optimal Parameters Found */}
                <div className="bg-gradient-to-r from-green-500/20 to-blue-500/20 border-2 border-green-500/30 rounded-xl p-6 mb-8">
                  <h3 className="text-green-400 font-bold text-lg mb-4 flex items-center gap-2">
                    <span className="text-2xl">âœ…</span>
                    Optimal Configuration: {validationResults.optimalParameters.name}
                  </h3>
                  <div className="grid md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <div className="text-white/60">Goal Weight</div>
                      <div className="text-white font-bold text-xl">{validationResults.optimalParameters.goalWeight}x</div>
                    </div>
                    <div>
                      <div className="text-white/60">Assist Weight</div>
                      <div className="text-white font-bold text-xl">{validationResults.optimalParameters.assistWeight}x</div>
                    </div>
                    <div>
                      <div className="text-white/60">Home Bonus</div>
                      <div className="text-white font-bold text-xl">{((validationResults.optimalParameters.homeBonus - 1) * 100).toFixed(0)}%</div>
                    </div>
                    <div>
                      <div className="text-white/60">Form Weight</div>
                      <div className="text-white font-bold text-xl">{validationResults.optimalParameters.formWeight}x</div>
                    </div>
                  </div>
                </div>

                {/* Parameter Comparison */}
                <div className="mb-8">
                  <h3 className="text-white font-bold mb-4">Configuration Testing Results</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-white/10">
                          <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Configuration</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Avg Error</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">RMSE</th>
                          <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Rating</th>
                        </tr>
                      </thead>
                      <tbody>
                        {validationResults.allParameterTests?.map((test, idx) => (
                          <tr key={idx} className={`border-b border-white/5 ${idx === 0 ? 'bg-green-500/10' : ''}`}>
                            <td className="py-3 px-4">
                              <span className="text-white font-medium">{test.name}</span>
                              {idx === 0 && <span className="ml-2 text-green-400 text-xs">âœ¨ BEST</span>}
                            </td>
                            <td className="py-3 px-4 text-right">
                              <span className={`font-semibold ${
                                test.avgError < 3 ? 'text-green-400' : 
                                test.avgError < 5 ? 'text-yellow-400' : 'text-red-400'
                              }`}>
                                Â±{test.avgError.toFixed(2)}
                              </span>
                            </td>
                            <td className="py-3 px-4 text-right text-white/80">{test.rmse.toFixed(2)}</td>
                            <td className="py-3 px-4">
                              <span className={`text-xs ${
                                test.avgError < 3 ? 'text-green-400' : 
                                test.avgError < 5 ? 'text-yellow-400' : 'text-red-400'
                              }`}>
                                {test.avgError < 3 ? 'â­â­â­ Excellent' : 
                                 test.avgError < 5 ? 'â­â­ Good' : 'â­ Needs Work'}
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Accuracy Metrics */}
                <div className="grid md:grid-cols-4 gap-4 mb-8">
                  <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-6 text-center">
                    <div className="text-blue-400 text-sm font-semibold mb-2">Avg Points Error</div>
                    <div className={`text-3xl font-bold ${
                      validationResults.metrics.avgPointsError < 3 ? 'text-green-400' :
                      validationResults.metrics.avgPointsError < 5 ? 'text-yellow-400' : 'text-red-400'
                    }`}>
                      Â±{validationResults.metrics.avgPointsError.toFixed(2)}
                    </div>
                    <div className="text-white/40 text-xs mt-1">pts per player</div>
                  </div>

                  <div className="bg-purple-500/10 border border-purple-500/20 rounded-xl p-6 text-center">
                    <div className="text-purple-400 text-sm font-semibold mb-2">RMSE</div>
                    <div className="text-white text-3xl font-bold">
                      {validationResults.metrics.rmse.toFixed(2)}
                    </div>
                    <div className="text-white/40 text-xs mt-1">root mean square</div>
                  </div>

                  <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-6 text-center">
                    <div className="text-red-400 text-sm font-semibold mb-2">Goals Error</div>
                    <div className="text-white text-3xl font-bold">
                      Â±{validationResults.metrics.avgGoalsError.toFixed(2)}
                    </div>
                    <div className="text-white/40 text-xs mt-1">goals per player</div>
                  </div>

                  <div className="bg-green-500/10 border border-green-500/20 rounded-xl p-6 text-center">
                    <div className="text-green-400 text-sm font-semibold mb-2">Assists Error</div>
                    <div className="text-white text-3xl font-bold">
                      Â±{validationResults.metrics.avgAssistsError.toFixed(2)}
                    </div>
                    <div className="text-white/40 text-xs mt-1">assists per player</div>
                  </div>
                </div>

                {/* By Position Breakdown */}
                {validationResults.byPosition && (
                  <div className="mb-8">
                    <h3 className="text-white font-bold mb-4">Accuracy by Position</h3>
                    <div className="grid md:grid-cols-4 gap-4">
                      {Object.entries(validationResults.byPosition).map(([pos, stats]) => (
                        <div key={pos} className="bg-white/5 rounded-lg p-4 border border-white/10">
                          <div className="text-white font-semibold mb-2 flex items-center gap-2">
                            {pos === 'FWD' && 'âš½'}
                            {pos === 'MID' && 'ðŸŽ¯'}
                            {pos === 'DEF' && 'ðŸ›¡ï¸'}
                            {pos === 'GK' && 'ðŸ§¤'}
                            {pos}
                          </div>
                          <div className="text-xs space-y-1">
                            <div className="flex justify-between">
                              <span className="text-white/60">Tested:</span>
                              <span className="text-white">{stats.count} players</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-white/60">Avg Error:</span>
                              <span className={`font-semibold ${
                                stats.avgError < 3 ? 'text-green-400' : 
                                stats.avgError < 5 ? 'text-yellow-400' : 'text-red-400'
                              }`}>
                                Â±{stats.avgError.toFixed(1)}
                              </span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Interpretation */}
                <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-6 mb-8">
                  <h3 className="text-yellow-400 font-semibold mb-3 flex items-center gap-2">
                    <span className="text-xl">ðŸ“Š</span>
                    Interpretation
                  </h3>
                  <div className="grid md:grid-cols-2 gap-4 text-sm text-white/80">
                    <div>
                      <strong className="text-white">Model Accuracy: {validationResults.metrics.avgPointsError.toFixed(1)} pts error</strong>
                      <p className="text-white/60 mt-1">
                        {validationResults.metrics.avgPointsError < 3 
                          ? 'âœ… Excellent! Model is highly accurate across the entire season.'
                          : validationResults.metrics.avgPointsError < 5
                          ? 'âš ï¸ Good performance. Predictions are reliable for waiver decisions.'
                          : 'âŒ Model needs improvement. Use predictions cautiously.'}
                      </p>
                    </div>
                    <div>
                      <strong className="text-white">Optimal Configuration Applied</strong>
                      <p className="text-white/60 mt-1">
                        System tested 5 different parameter sets and automatically selected the best performing configuration. 
                        These optimized parameters will be used for future predictions.
                      </p>
                    </div>
                  </div>
                </div>

                {/* Biggest Misses & Best Predictions */}
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <h3 className="text-lg font-bold text-red-400 mb-4">âŒ Biggest Misses</h3>
                    <div className="space-y-2">
                      {validationResults.biggestMisses?.slice(0, 10).map((player, idx) => (
                        <div key={idx} className="bg-red-500/5 border border-red-500/10 rounded-lg p-3">
                          <div className="flex justify-between items-start mb-1">
                            <div>
                              <div className="text-white font-medium text-sm">{player.name}</div>
                              <div className="text-white/50 text-xs">{player.team} â€¢ {player.position}</div>
                            </div>
                            <div className="text-red-400 font-bold text-lg">
                              Â±{player.errors.points.toFixed(1)}
                            </div>
                          </div>
                          <div className="flex gap-4 text-xs">
                            <span className="text-white/60">
                              Predicted: {player.predicted.points.toFixed(1)}pts
                            </span>
                            <span className="text-white/60">
                              Actual: {player.actual.points}pts
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <h3 className="text-lg font-bold text-green-400 mb-4">âœ… Best Predictions</h3>
                    <div className="space-y-2">
                      {validationResults.bestPredictions?.slice(0, 10).map((player, idx) => (
                        <div key={idx} className="bg-green-500/5 border border-green-500/10 rounded-lg p-3">
                          <div className="flex justify-between items-start mb-1">
                            <div>
                              <div className="text-white font-medium text-sm">{player.name}</div>
                              <div className="text-white/50 text-xs">{player.team} â€¢ {player.position}</div>
                            </div>
                            <div className="text-green-400 font-bold text-lg">
                              Â±{player.errors.points.toFixed(1)}
                            </div>
                          </div>
                          <div className="flex gap-4 text-xs">
                            <span className="text-white/60">
                              Predicted: {player.predicted.points.toFixed(1)}pts
                            </span>
                            <span className="text-white/60">
                              Actual: {player.actual.points}pts
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Player Analysis Results */}
            {playerAnalysis && (
              <div className="glass-card rounded-2xl p-8 fade-in border-2 border-purple-500/30">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <span className="text-4xl">ðŸ”®</span>
                    <div>
                      <h2 className="text-2xl font-bold text-white">
                        Next 5 Gameweeks Predictions
                      </h2>
                      <p className="text-sm text-white/50">
                        GWs {playerAnalysis.next5GWs.join(', ')} â€¢ Based on form, fixtures & performance
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={() => setPlayerAnalysis(null)}
                    className="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-all text-sm"
                  >
                    Close
                  </button>
                </div>

                {/* Top 50 Overall */}
                <div className="mb-8">
                  <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span className="text-2xl">ðŸ†</span>
                    Top 50 Players
                  </h3>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-white/10">
                          <th className="text-left py-3 px-2 text-white/60 font-medium text-sm">Rank</th>
                          <th className="text-left py-3 px-3 text-white/60 font-medium text-sm">Player</th>
                          <th className="text-left py-3 px-2 text-white/60 font-medium text-sm">Team</th>
                          <th className="text-left py-3 px-2 text-white/60 font-medium text-sm">Pos</th>
                          <th className="text-right py-3 px-2 text-white/60 font-medium text-sm">Form</th>
                          <th className="text-right py-3 px-2 text-white/60 font-medium text-sm">PPG</th>
                          <th className="text-right py-3 px-2 text-white/60 font-medium text-sm">Own%</th>
                          <th className="text-left py-3 px-3 text-white/60 font-medium text-sm">Next 5 Fixtures</th>
                          <th className="text-right py-3 px-3 text-white/60 font-medium text-sm">Exp Pts</th>
                        </tr>
                      </thead>
                      <tbody>
                        {playerAnalysis.top50.map((player, idx) => (
                          <tr key={idx} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                            <td className="py-3 px-2">
                              <span className={`font-bold ${
                                idx < 3 ? 'text-yellow-400' : idx < 10 ? 'text-purple-400' : 'text-white/60'
                              }`}>
                                #{idx + 1}
                              </span>
                            </td>
                            <td className="py-3 px-3">
                              <div>
                                <div className="text-white font-medium">{player.name}</div>
                                <div className="text-white/40 text-xs">{player.fullName}</div>
                              </div>
                            </td>
                            <td className="py-3 px-2 text-white/80 text-sm">{player.team}</td>
                            <td className="py-3 px-2 text-white/80 text-sm font-semibold">{player.position}</td>
                            <td className="py-3 px-2 text-right text-purple-400 font-semibold">{player.form.toFixed(1)}</td>
                            <td className="py-3 px-2 text-right text-white/80">{player.ppg.toFixed(2)}</td>
                            <td className="py-3 px-2 text-right text-white/60 text-sm">{player.ownership.toFixed(0)}%</td>
                            <td className="py-3 px-3">
                              <div className="flex gap-1 flex-wrap">
                                {player.fixtures.map((fix, i) => (
                                  <span key={i} className="text-xs bg-white/10 px-2 py-1 rounded text-white/70">
                                    {fix}
                                  </span>
                                ))}
                              </div>
                            </td>
                            <td className="py-3 px-3 text-right">
                              <span className="text-green-400 font-bold text-lg">
                                {player.expectedPoints.toFixed(1)}
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* By Position */}
                <div className="grid md:grid-cols-2 gap-6 mb-8">
                  {Object.entries(playerAnalysis.byPosition).map(([position, players]) => (
                    <div key={position} className="bg-white/5 rounded-xl p-6 border border-white/10">
                      <h4 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        {position === 'FWD' && 'âš½'}
                        {position === 'MID' && 'ðŸŽ¯'}
                        {position === 'DEF' && 'ðŸ›¡ï¸'}
                        {position === 'GK' && 'ðŸ§¤'}
                        {' '}{position}
                      </h4>
                      <div className="space-y-2">
                        {players.map((player, idx) => (
                          <div key={idx} className="flex items-center justify-between py-2 border-b border-white/5">
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                <span className="text-white/40 text-sm font-bold">#{idx + 1}</span>
                                <span className="text-white font-medium text-sm">{player.name}</span>
                                <span className="text-white/40 text-xs">{player.team}</span>
                              </div>
                              <div className="text-xs text-white/40 mt-1">
                                {player.fixtures.join(' ')}
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-green-400 font-bold">{player.expectedPoints.toFixed(1)}</div>
                              <div className="text-white/40 text-xs">Form: {player.form.toFixed(1)}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>

                {/* Hidden Gems */}
                <div className="bg-gradient-to-br from-purple-500/10 to-blue-500/10 border border-purple-500/20 rounded-xl p-6">
                  <h3 className="text-xl font-bold text-purple-300 mb-4 flex items-center gap-2">
                    <span className="text-2xl">ðŸ’Ž</span>
                    Hidden Gems (Ownership &lt; 30%)
                  </h3>
                  <div className="grid md:grid-cols-2 gap-4">
                    {playerAnalysis.hiddenGems.slice(0, 10).map((player, idx) => (
                      <div key={idx} className="bg-white/5 rounded-lg p-4">
                        <div className="flex items-start justify-between mb-2">
                          <div>
                            <div className="text-white font-semibold">{player.name}</div>
                            <div className="text-white/60 text-sm">{player.team} â€¢ {player.position}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-green-400 font-bold text-lg">{player.expectedPoints.toFixed(1)}</div>
                            <div className="text-white/40 text-xs">{player.ownership.toFixed(0)}% owned</div>
                          </div>
                        </div>
                        <div className="text-xs text-white/50">
                          {player.fixtures.join(' â€¢ ')}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* Position History */}
            {positionHistory.length > 0 && (
              <div className="glass-card rounded-2xl p-8 fade-in">
                <div className="flex items-center gap-3 mb-6">
                  <TrendingUp size={24} className="text-yellow-400" />
                  <h2 className="text-2xl font-bold text-white">
                    Position History
                  </h2>
                </div>
                
                <PositionChart />
              </div>
            )}

            {/* Standings Table */}
            {standings.length > 0 && (
              <div className="glass-card rounded-2xl p-8 fade-in">
                <h2 className="text-2xl font-bold text-white mb-6">
                  League Standings
                </h2>
                
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-white/10">
                        <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Rank</th>
                        <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Manager</th>
                        <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Team</th>
                        <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Points</th>
                        <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Punishment</th>
                      </tr>
                    </thead>
                    <tbody>
                      {standings.map((team, idx) => {
                        const isPunishment = team.rank === 1 || team.rank >= 10 || (team.rank >= 7 && team.rank <= 8);
                        let punishmentText = '-';
                        
                        if (team.rank === 1) {
                          punishmentText = '$200 merch (paid by others)';
                        } else if (team.rank === 7) {
                          punishmentText = '8hrs at McDonald\'s';
                        } else if (team.rank === 8) {
                          punishmentText = '10hrs at McDonald\'s';
                        } else if (team.rank === 10) {
                          punishmentText = '12hrs at McDonald\'s';
                        } else if (team.rank === 11) {
                          punishmentText = '14hrs at McDonald\'s';
                        } else if (team.rank === 12) {
                          punishmentText = '18hrs at McDonald\'s';
                        }
                        
                        return (
                          <tr 
                            key={team.entry_id}
                            className={`border-b border-white/5 transition-colors hover:bg-white/5 ${
                              isPunishment ? 'bg-yellow-400/5' : ''
                            }`}
                          >
                            <td className="py-4 px-4">
                              <div className="flex items-center gap-2">
                                <span className={`text-lg font-bold ${
                                  team.rank === 1 ? 'text-yellow-400' : 'text-white'
                                }`}>
                                  {team.rank}
                                </span>
                                {team.rank === 1 && <span className="text-xl">ðŸ†</span>}
                                {isPunishment && team.rank !== 1 && <span className="text-xl">ðŸŸ</span>}
                              </div>
                            </td>
                            <td className="py-4 px-4">
                              <span className="text-white font-medium">
                                {team.player_first_name} {team.player_last_name}
                              </span>
                            </td>
                            <td className="py-4 px-4">
                              <span className="text-white/60">
                                {team.entry_name}
                              </span>
                            </td>
                            <td className="py-4 px-4 text-right">
                              <span className="text-white font-semibold">
                                {team.points_for || team.total || 0}
                              </span>
                            </td>
                            <td className="py-4 px-4 text-right">
                              <span className={isPunishment ? 'text-yellow-400 font-medium' : 'text-white/40'}>
                                {punishmentText}
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Transfer Hall of Shame & Fame */}
            {transferAnalysis && (
              <>
                {/* Bench Points Waste */}
                <div className="glass-card rounded-2xl p-8 fade-in border-2 border-red-500/30">
                  <div className="flex items-center gap-3 mb-6">
                    <span className="text-4xl">ðŸª‘</span>
                    <div>
                      <h2 className="text-2xl font-bold text-white">
                        Bench Points Wasted
                      </h2>
                      <p className="text-sm text-white/50">
                        Points left on the bench all season ðŸ’”
                      </p>
                    </div>
                  </div>

                  <div className="grid md:grid-cols-2 gap-6 mb-6">
                    {/* Hall of Shame - Most bench points */}
                    <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-6">
                      <h3 className="text-lg font-semibold text-red-400 mb-4 flex items-center gap-2">
                        <span className="text-2xl">ðŸ˜­</span>
                        Hall of Shame
                      </h3>
                      <div className="space-y-3">
                        {transferAnalysis.byBenchPoints?.slice(0, 5).map((team, idx) => (
                          <div key={idx} className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                              <span className="text-red-400 font-bold text-lg">#{idx + 1}</span>
                              <span className="text-white font-medium">{team.player_name}</span>
                            </div>
                            <div className="text-right">
                              <div className="text-red-400 font-bold text-xl">{team.totalBenchPoints}</div>
                              <div className="text-red-400/60 text-xs">{team.avgBenchPoints} avg/GW</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Smart Starters */}
                    <div className="bg-green-500/10 border border-green-500/20 rounded-xl p-6">
                      <h3 className="text-lg font-semibold text-green-400 mb-4 flex items-center gap-2">
                        <span className="text-2xl">ðŸ§ </span>
                        Smart Starters
                      </h3>
                      <div className="space-y-3">
                        {transferAnalysis.byBenchPoints?.slice().reverse().slice(0, 5).map((team, idx) => (
                          <div key={idx} className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                              <span className="text-green-400 font-bold text-lg">#{idx + 1}</span>
                              <span className="text-white font-medium">{team.player_name}</span>
                            </div>
                            <div className="text-right">
                              <div className="text-green-400 font-bold text-xl">{team.totalBenchPoints}</div>
                              <div className="text-green-400/60 text-xs">{team.avgBenchPoints} avg/GW</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Full bench breakdown */}
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-white/10">
                          <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Rank</th>
                          <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Manager</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Total Bench Pts</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Avg per GW</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Efficiency</th>
                        </tr>
                      </thead>
                      <tbody>
                        {transferAnalysis.byBenchPoints?.map((team, idx) => {
                          const currentTeam = standings.find(s => s.entry_id === team.entry_id);
                          const efficiency = currentTeam ? (100 - (team.totalBenchPoints / currentTeam.points_for * 100)).toFixed(1) : 0;
                          
                          return (
                            <tr key={idx} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                              <td className="py-3 px-4">
                                <span className={`font-bold ${
                                  idx < 3 ? 'text-red-400' : idx >= transferAnalysis.byBenchPoints.length - 3 ? 'text-green-400' : 'text-white/60'
                                }`}>
                                  #{idx + 1}
                                </span>
                              </td>
                              <td className="py-3 px-4">
                                <span className="text-white font-medium">{team.player_name}</span>
                              </td>
                              <td className="py-3 px-4 text-right">
                                <span className="text-white font-bold text-lg">{team.totalBenchPoints}</span>
                              </td>
                              <td className="py-3 px-4 text-right">
                                <span className="text-white/80">{team.avgBenchPoints}</span>
                              </td>
                              <td className="py-3 px-4 text-right">
                                <span className={`font-semibold ${
                                  efficiency >= 95 ? 'text-green-400' : efficiency >= 90 ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                  {efficiency}%
                                </span>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Transfer Activity Stats */}
                <div className="glass-card rounded-2xl p-8 fade-in">
                  <div className="flex items-center gap-3 mb-6">
                    <span className="text-4xl">ðŸ“Š</span>
                    <div>
                      <h2 className="text-2xl font-bold text-white">
                        Transfer Activity
                      </h2>
                      <p className="text-sm text-white/50">
                        {transferAnalysis.totalTransfers} total waiver transfers this season
                      </p>
                    </div>
                  </div>

                  <div className="grid md:grid-cols-3 gap-6 mb-8">
                    {/* Most Active */}
                    <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-6">
                      <h3 className="text-blue-400 font-semibold mb-4 text-sm">Most Active</h3>
                      <div className="space-y-2">
                        {transferAnalysis.byTotal.slice(0, 3).map((team, idx) => (
                          <div key={idx} className="flex items-center justify-between">
                            <span className="text-white/80 text-sm">{team.player_name}</span>
                            <span className="text-blue-400 font-bold">{team.transferCount}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Least Active */}
                    <div className="bg-purple-500/10 border border-purple-500/20 rounded-xl p-6">
                      <h3 className="text-purple-400 font-semibold mb-4 text-sm">Set & Forget</h3>
                      <div className="space-y-2">
                        {transferAnalysis.byTotal.slice().reverse().slice(0, 3).map((team, idx) => (
                          <div key={idx} className="flex items-center justify-between">
                            <span className="text-white/80 text-sm">{team.player_name}</span>
                            <span className="text-purple-400 font-bold">{team.transferCount}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Average */}
                    <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-6">
                      <h3 className="text-yellow-400 font-semibold mb-4 text-sm">League Stats</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                          <span className="text-white/60">Avg Transfers</span>
                          <span className="text-yellow-400 font-bold">
                            {(transferAnalysis.totalTransfers / transferAnalysis.byTotal.length).toFixed(1)}
                          </span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-white/60">Most in 1 GW</span>
                          <span className="text-yellow-400 font-bold">-</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-white/60">Total Processed</span>
                          <span className="text-yellow-400 font-bold">{transferAnalysis.totalTransfers}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* Transfer Analysis */}
            {transferAnalysis && (
              <div className="glass-card rounded-2xl p-8 fade-in">
                <h2 className="text-2xl font-bold text-white mb-6">
                  Transfer Analysis
                </h2>
                
                <div className="mb-8">
                  <p className="text-white/60 text-sm mb-4">
                    Analyzing {allTransactions.filter(t => t.kind === 'w' && t.result === 'a').length} accepted waiver transfers across the season
                  </p>
                </div>
                
                <div className="grid md:grid-cols-2 gap-8 mb-8">
                  {/* Total Impact Leaderboard */}
                  <div>
                    <h3 className="text-lg font-semibold text-white/90 mb-4 flex items-center gap-2">
                      <span className="text-2xl">ðŸ”¥</span>
                      Total Transfer Impact
                    </h3>
                    <div className="space-y-3">
                      {transferAnalysis.byTotal.slice(0, 8).map((team, idx) => (
                        <div key={idx} className="group">
                          <div className="flex items-center justify-between mb-1">
                            <div className="flex items-center gap-3">
                              <span className={`text-sm font-bold ${
                                idx === 0 ? 'text-yellow-400' : idx === 1 ? 'text-gray-300' : idx === 2 ? 'text-orange-400' : 'text-white/60'
                              }`}>
                                #{idx + 1}
                              </span>
                              <span className="text-white font-medium">{team.player_name}</span>
                            </div>
                            <div className="text-right">
                              <span className={`font-bold ${
                                team.totalImpact > 0 ? 'text-green-400' : team.totalImpact < 0 ? 'text-red-400' : 'text-white/60'
                              }`}>
                                {team.totalImpact > 0 ? '+' : ''}{team.totalImpact} pts
                              </span>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="flex-1 h-2 bg-white/5 rounded-full overflow-hidden">
                              <div 
                                className={`h-full transition-all duration-500 ${
                                  team.totalImpact > 0 ? 'bg-green-500' : team.totalImpact < 0 ? 'bg-red-500' : 'bg-white/20'
                                }`}
                                style={{
                                  width: `${Math.min(100, Math.abs(team.totalImpact) / Math.max(...transferAnalysis.byTotal.map(t => Math.abs(t.totalImpact))) * 100)}%`
                                }}
                              />
                            </div>
                            <span className="text-xs text-white/40 min-w-[80px] text-right">
                              {team.transferCount} transfers
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Average Impact (Decision Quality) */}
                  <div>
                    <h3 className="text-lg font-semibold text-white/90 mb-4 flex items-center gap-2">
                      <span className="text-2xl">ðŸŽ¯</span>
                      Transfer Decision Quality
                    </h3>
                    <p className="text-xs text-white/40 mb-4">Points per transfer (min 5 transfers)</p>
                    <div className="space-y-3">
                      {transferAnalysis.byAverage.filter(t => t.transferCount >= 5).slice(0, 8).map((team, idx) => (
                        <div key={idx} className="group">
                          <div className="flex items-center justify-between mb-1">
                            <div className="flex items-center gap-3">
                              <span className={`text-sm font-bold ${
                                idx === 0 ? 'text-yellow-400' : idx === 1 ? 'text-gray-300' : idx === 2 ? 'text-orange-400' : 'text-white/60'
                              }`}>
                                #{idx + 1}
                              </span>
                              <span className="text-white font-medium">{team.player_name}</span>
                            </div>
                            <div className="text-right">
                              <span className={`font-bold ${
                                team.avgImpact > 0 ? 'text-green-400' : team.avgImpact < 0 ? 'text-red-400' : 'text-white/60'
                              }`}>
                                {team.avgImpact > 0 ? '+' : ''}{team.avgImpact.toFixed(1)} avg
                              </span>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="flex-1 h-2 bg-white/5 rounded-full overflow-hidden">
                              <div 
                                className={`h-full transition-all duration-500 ${
                                  team.avgImpact > 0 ? 'bg-green-500' : team.avgImpact < 0 ? 'bg-red-500' : 'bg-white/20'
                                }`}
                                style={{
                                  width: `${Math.min(100, Math.abs(team.avgImpact) / Math.max(...transferAnalysis.byAverage.map(t => Math.abs(t.avgImpact))) * 100)}%`
                                }}
                              />
                            </div>
                            <span className="text-xs text-white/40 min-w-[80px] text-right">
                              {team.transferCount} transfers
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
                
                {/* Full Table */}
                <div className="mt-8">
                  <h3 className="text-lg font-semibold text-white/90 mb-4">Complete Transfer Breakdown</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-white/10">
                          <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Manager</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Transfers</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Total Impact</th>
                          <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Avg Impact</th>
                        </tr>
                      </thead>
                      <tbody>
                        {transferAnalysis.byTotal.map((team, idx) => (
                          <tr key={idx} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                            <td className="py-3 px-4">
                              <span className="text-white font-medium">{team.player_name}</span>
                            </td>
                            <td className="py-3 px-4 text-right">
                              <span className="text-white/80">{team.transferCount}</span>
                            </td>
                            <td className="py-3 px-4 text-right">
                              <span className={`font-semibold ${
                                team.totalImpact > 0 ? 'text-green-400' : team.totalImpact < 0 ? 'text-red-400' : 'text-white/60'
                              }`}>
                                {team.totalImpact > 0 ? '+' : ''}{team.totalImpact}
                              </span>
                            </td>
                            <td className="py-3 px-4 text-right">
                              <span className={`font-semibold ${
                                team.avgImpact > 0 ? 'text-green-400' : team.avgImpact < 0 ? 'text-red-400' : 'text-white/60'
                              }`}>
                                {team.avgImpact > 0 ? '+' : ''}{team.avgImpact.toFixed(1)}
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {analysisLoading && (
              <div className="glass-card rounded-2xl p-8 text-center">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400 mb-4"></div>
                <p className="text-white/60">{analysisProgress}</p>
              </div>
            )}
          </div>

          {/* Settings Modal */}
          {showConfig && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
              <div className="glass-card rounded-2xl p-8 max-w-md w-full shadow-2xl">
                <h2 className="text-2xl font-bold text-white mb-6">Settings</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-white/80 text-sm font-medium mb-2">
                      League ID
                    </label>
                    <input
                      type="text"
                      value={config.leagueId}
                      onChange={(e) => setConfig({...config, leagueId: e.target.value})}
                      className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-yellow-400/50"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-white/80 text-sm font-medium mb-2">
                      Your Team ID
                    </label>
                    <input
                      type="text"
                      value={config.userTeamId}
                      onChange={(e) => setConfig({...config, userTeamId: e.target.value})}
                      className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-yellow-400/50"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-white/80 text-sm font-medium mb-2">
                      League Name
                    </label>
                    <input
                      type="text"
                      value={config.leagueName}
                      onChange={(e) => setConfig({...config, leagueName: e.target.value})}
                      className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-yellow-400/50"
                    />
                  </div>
                </div>
                
                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => {
                      localStorage.setItem('fpl-config', JSON.stringify(config));
                      setShowConfig(false);
                      if (config.leagueId) fetchLeagueData();
                    }}
                    className="flex-1 py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-semibold rounded-xl hover:from-yellow-300 hover:to-yellow-400 transition-all"
                  >
                    Save & Refresh
                  </button>
                  <button 
                    onClick={() => setShowConfig(false)}
                    className="px-6 py-3 bg-white/10 text-white font-semibold rounded-xl hover:bg-white/20 transition-all"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
