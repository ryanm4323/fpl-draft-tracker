<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spreadsheet Merchants 3.0 - FPL Draft Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      min-height: 100vh;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .danger-overlay {
      background: linear-gradient(90deg, rgba(220, 38, 38, 0.15) 0%, rgba(220, 38, 38, 0.05) 100%);
    }
    
    .position-line {
      transition: stroke-width 0.2s, opacity 0.2s;
    }
    
    .position-line:hover {
      stroke-width: 4 !important;
      opacity: 1 !important;
    }
    
    .team-legend-item:hover .position-line {
      stroke-width: 4 !important;
      opacity: 1 !important;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    .tooltip {
      position: absolute;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }
  </style>
</head>
<body class="antialiased">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // Modern icon components
    const RefreshCw = ({ size = 20, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" className={className}>
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
      </svg>
    );
    
    const Settings = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v6m0 6v6"/>
        <path d="M12 12h9M3 12h9"/>
      </svg>
    );
    
    const TrendingUp = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
        <polyline points="17 6 23 6 23 12"/>
      </svg>
    );
    
    const Lock = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
    );

    function App() {
      const [config, setConfig] = useState({
        leagueId: '10991',
        userTeamId: '81877',
        password: 'merchants2026',
        leagueName: 'Spreadsheet Merchants 3.0'
      });
      
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [passwordInput, setPasswordInput] = useState('');
      const [showConfig, setShowConfig] = useState(false);
      const [leagueData, setLeagueData] = useState(null);
      const [standings, setStandings] = useState([]);
      const [allTransactions, setAllTransactions] = useState([]);
      const [transferAnalysis, setTransferAnalysis] = useState(null);
      const [analysisLoading, setAnalysisLoading] = useState(false);
      const [analysisProgress, setAnalysisProgress] = useState('');
      const [positionHistory, setPositionHistory] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [hoveredTeam, setHoveredTeam] = useState(null);
      
      const svgRef = useRef(null);

      useEffect(() => {
        const saved = localStorage.getItem('fpl-config');
        if (saved) {
          setConfig(JSON.parse(saved));
        }
        const auth = localStorage.getItem('fpl-auth');
        if (auth === 'true') {
          setIsAuthenticated(true);
        }
      }, []);

      useEffect(() => {
        if (isAuthenticated && config.leagueId) {
          fetchLeagueData();
        }
      }, [isAuthenticated]);

      const handleLogin = () => {
        if (passwordInput === config.password) {
          setIsAuthenticated(true);
          localStorage.setItem('fpl-auth', 'true');
        } else {
          alert('Incorrect password');
        }
      };

      const fetchLeagueData = async () => {
        setLoading(true);
        setError(null);
        
        try {
          const apiBase = '/.netlify/functions/fpl-proxy?endpoint=';
          
          const leagueResponse = await fetch(`${apiBase}/api/league/${config.leagueId}/details`);
          if (!leagueResponse.ok) {
            throw new Error(`Failed to fetch league details`);
          }
          const league = await leagueResponse.json();
          
          setLeagueData(league);

          if (league.standings && league.league_entries) {
            const standingsWithDetails = league.standings.map(standing => {
              const entry = league.league_entries.find(e => e.id === standing.league_entry);
              return {
                ...standing,
                entry_id: entry?.entry_id,
                entry_name: entry?.entry_name || `${entry?.player_first_name || ''} ${entry?.player_last_name || ''}`.trim(),
                player_name: `${entry?.player_first_name || ''} ${entry?.player_last_name || ''}`.trim(),
                player_first_name: entry?.player_first_name || '',
                player_last_name: entry?.player_last_name || ''
              };
            });
            setStandings(standingsWithDetails.sort((a, b) => a.rank - b.rank));
          }
          
          if (league.league_entries) {
            await buildPositionHistory(league.league_entries, apiBase, league);
            await fetchAllTransactions(league.league_entries, apiBase, league);
          }

          setLastUpdated(new Date());
        } catch (err) {
          setError(err.message);
          console.error('Error fetching data:', err);
        } finally {
          setLoading(false);
        }
      };

      const buildPositionHistory = async (leagueEntries, apiBase, league) => {
        try {
          const currentGW = league?.league?.current_event || 22;
          const cached = localStorage.getItem('position-history-cache');
          
          if (cached) {
            const cachedData = JSON.parse(cached);
            if (cachedData.history && cachedData.history.length === 0) {
              localStorage.removeItem('position-history-cache');
            } else if (cachedData.gameweek === currentGW && cachedData.timestamp > Date.now() - 86400000) {
              setPositionHistory(cachedData.history);
              return;
            }
          }
          
          const history = [];
          const teamHistories = [];
          
          for (const entry of leagueEntries) {
            try {
              const response = await fetch(`${apiBase}/api/entry/${entry.entry_id}/history`);
              if (!response.ok) continue;
              
              const data = await response.json();
              teamHistories.push({
                entry_id: entry.entry_id,
                entry_name: entry.entry_name,
                player_first_name: entry.player_first_name,
                player_last_name: entry.player_last_name,
                history: data.history || []
              });
              
              await new Promise(resolve => setTimeout(resolve, 100));
            } catch (e) {
              console.log(`Error fetching team ${entry.entry_id}:`, e);
            }
          }
          
          for (let gw = 1; gw <= currentGW; gw++) {
            const gwStandings = [];
            
            teamHistories.forEach(team => {
              const gwData = team.history.find(h => h.event === gw);
              
              if (gwData) {
                gwStandings.push({
                  entry_id: team.entry_id,
                  entry_name: team.entry_name,
                  player_first_name: team.player_first_name,
                  player_last_name: team.player_last_name,
                  total_points: gwData.total_points,
                  gw_points: gwData.points
                });
              }
            });
            
            gwStandings.sort((a, b) => b.total_points - a.total_points);
            
            gwStandings.forEach((team, index) => {
              history.push({
                gameweek: gw,
                entry_id: team.entry_id,
                entry_name: team.entry_name,
                player_first_name: team.player_first_name,
                player_last_name: team.player_last_name,
                position: index + 1,
                points: team.total_points
              });
            });
          }
          
          setPositionHistory(history);
          
          localStorage.setItem('position-history-cache', JSON.stringify({
            gameweek: currentGW,
            timestamp: Date.now(),
            history: history
          }));
          
        } catch (e) {
          console.log('Error building position history:', e);
        }
      };

      const fetchAllTransactions = async (leagueEntries, apiBase, league) => {
        const leagueId = league?.league?.id;
        if (!leagueId) return;

        try {
          const response = await fetch(`${apiBase}/api/draft/league/${leagueId}/transactions`);
          if (!response.ok) return;
          
          const data = await response.json();
          const transactions = data.transactions || [];
          
          setAllTransactions(transactions);
          
          const cached = localStorage.getItem('transfer-analysis-cache');
          
          if (cached) {
            const cachedData = JSON.parse(cached);
            const currentGW = leagueData?.current_event || 1;
            if (cachedData.gameweek === currentGW && cachedData.timestamp > Date.now() - 86400000) {
              setTransferAnalysis(cachedData.analysis);
              return;
            }
          }
          
          await analyzeTransfers(transactions, leagueEntries, apiBase, leagueId);
        } catch (e) {
          console.log('Error fetching transactions:', e);
        }
      };

      const analyzeTransfers = async (transactions, leagueEntries, apiBase, leagueId) => {
        setAnalysisLoading(true);
        
        try {
          setAnalysisProgress('Fetching player data...');
          
          const bootstrapResponse = await fetch(`${apiBase}/api/bootstrap-static`);
          const bootstrapData = await bootstrapResponse.json();
          
          const players = {};
          bootstrapData.elements.forEach(p => {
            players[p.id] = {
              name: p.web_name,
              team: p.team,
              position: p.element_type
            };
          });
          
          setAnalysisProgress('Analyzing transfers...');
          
          const teamImpact = {};
          leagueEntries.forEach(entry => {
            teamImpact[entry.entry_id] = {
              entry_name: entry.entry_name,
              player_name: `${entry.player_first_name} ${entry.player_last_name}`,
              totalImpact: 0,
              transferCount: 0,
              transfers: []
            };
          });
          
          const acceptedWaivers = transactions.filter(t => 
            t.kind === 'w' && 
            t.result === 'a' && 
            t.element_in && 
            t.element_out
          );
          
          acceptedWaivers.forEach(trans => {
            const playerIn = players[trans.element_in];
            const playerOut = players[trans.element_out];
            const gwPicked = trans.event;
            
            if (playerIn && playerOut) {
              teamImpact[trans.entry].transferCount++;
              teamImpact[trans.entry].transfers.push({
                gw: gwPicked,
                playerIn: playerIn.name,
                playerOut: playerOut.name
              });
            }
          });
          
          const impactArray = Object.values(teamImpact)
            .filter(t => t.transferCount > 0)
            .sort((a, b) => b.totalImpact - a.totalImpact);
          
          const avgArray = impactArray
            .map(t => ({
              ...t,
              avgImpact: t.transferCount > 0 ? t.totalImpact / t.transferCount : 0
            }))
            .sort((a, b) => b.avgImpact - a.avgImpact);
          
          setTransferAnalysis({
            byTotal: impactArray,
            byAverage: avgArray
          });
          
          const currentGW = leagueData?.current_event || 1;
          localStorage.setItem('transfer-analysis-cache', JSON.stringify({
            gameweek: currentGW,
            timestamp: Date.now(),
            analysis: {
              byTotal: impactArray,
              byAverage: avgArray
            }
          }));
          
        } catch (e) {
          console.error('Analysis error:', e);
        } finally {
          setAnalysisLoading(false);
          setAnalysisProgress('');
        }
      };

      // Position History Chart Component
      const PositionChart = () => {
        if (positionHistory.length === 0) return null;
        
        const maxGW = Math.max(...positionHistory.map(h => h.gameweek));
        const colors = [
          '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#06b6d4', '#ef4444',
          '#ec4899', '#14b8a6', '#f97316', '#84cc16', '#a855f7', '#fb923c'
        ];
        
        const chartWidth = 1000;
        const chartHeight = 500;
        const padding = { top: 40, right: 120, bottom: 60, left: 60 };
        const plotWidth = chartWidth - padding.left - padding.right;
        const plotHeight = chartHeight - padding.top - padding.bottom;
        
        return (
          <div className="relative">
            <svg 
              ref={svgRef}
              width="100%" 
              height={chartHeight} 
              viewBox={`0 0 ${chartWidth} ${chartHeight}`}
              className="overflow-visible"
            >
              {/* Background danger zones */}
              <defs>
                <pattern id="dangerPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                  <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" stroke="#ef4444" strokeWidth="0.5" opacity="0.1"/>
                </pattern>
              </defs>
              
              {/* Danger zone backgrounds */}
              {[7, 8, 10, 11, 12].map(pos => (
                <rect
                  key={pos}
                  x={padding.left}
                  y={padding.top + (pos - 1) * (plotHeight / 12)}
                  width={plotWidth}
                  height={plotHeight / 12}
                  fill="url(#dangerPattern)"
                  opacity="0.3"
                />
              ))}
              
              {/* Grid lines */}
              {Array.from({length: 13}, (_, i) => i).map(pos => (
                <g key={pos}>
                  <line
                    x1={padding.left}
                    y1={padding.top + pos * (plotHeight / 12)}
                    x2={chartWidth - padding.right}
                    y2={padding.top + pos * (plotHeight / 12)}
                    stroke="rgba(255, 255, 255, 0.1)"
                    strokeWidth={pos === 0 || pos === 6 || pos === 9 || pos === 12 ? "2" : "1"}
                  />
                  {pos < 12 && (
                    <text
                      x={padding.left - 15}
                      y={padding.top + pos * (plotHeight / 12) + (plotHeight / 24)}
                      fill="rgba(255, 255, 255, 0.5)"
                      fontSize="12"
                      textAnchor="end"
                      dominantBaseline="middle"
                    >
                      {pos + 1}
                    </text>
                  )}
                </g>
              ))}
              
              {/* Gameweek labels */}
              {Array.from({length: maxGW}, (_, i) => i + 1).filter(gw => gw % 2 === 1).map(gw => (
                <text
                  key={gw}
                  x={padding.left + ((gw - 1) / maxGW) * plotWidth}
                  y={chartHeight - padding.bottom + 25}
                  fill="rgba(255, 255, 255, 0.5)"
                  fontSize="11"
                  textAnchor="middle"
                >
                  GW{gw}
                </text>
              ))}
              
              {/* Team lines */}
              {standings.map((team, idx) => {
                const teamHistory = positionHistory
                  .filter(h => h.entry_id === team.entry_id)
                  .sort((a, b) => a.gameweek - b.gameweek);
                
                if (teamHistory.length === 0) return null;
                
                const color = colors[idx % colors.length];
                const isHovered = hoveredTeam === team.entry_id;
                
                const points = teamHistory.map(h => ({
                  x: padding.left + ((h.gameweek - 1) / maxGW) * plotWidth,
                  y: padding.top + (h.position - 0.5) * (plotHeight / 12),
                  gw: h.gameweek,
                  pos: h.position,
                  points: h.points,
                  inDanger: [7, 8, 10, 11, 12].includes(h.position)
                }));
                
                // Create path
                const pathD = points.map((p, i) => 
                  `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
                ).join(' ');
                
                return (
                  <g 
                    key={team.entry_id}
                    className="team-line-group"
                    onMouseEnter={() => setHoveredTeam(team.entry_id)}
                    onMouseLeave={() => setHoveredTeam(null)}
                  >
                    {/* Glow effect when hovered */}
                    {isHovered && (
                      <path
                        d={pathD}
                        stroke={color}
                        strokeWidth="8"
                        fill="none"
                        opacity="0.2"
                        filter="blur(4px)"
                      />
                    )}
                    
                    {/* Main line */}
                    <path
                      d={pathD}
                      stroke={color}
                      strokeWidth={isHovered ? "3" : "2"}
                      fill="none"
                      opacity={hoveredTeam === null || isHovered ? "0.9" : "0.2"}
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      className="position-line transition-all duration-200"
                    />
                    
                    {/* Data points */}
                    {points.map((point, i) => (
                      <circle
                        key={i}
                        cx={point.x}
                        cy={point.y}
                        r={isHovered ? "5" : "3"}
                        fill={point.inDanger ? "#ef4444" : color}
                        stroke="white"
                        strokeWidth="1.5"
                        opacity={hoveredTeam === null || isHovered ? "1" : "0.3"}
                        className="transition-all duration-200"
                      >
                        <title>
                          {team.player_first_name} {team.player_last_name}
                          {'\n'}GW{point.gw}: P{point.pos} ({point.points} pts)
                        </title>
                      </circle>
                    ))}
                    
                    {/* Name label at end */}
                    {isHovered && points.length > 0 && (
                      <text
                        x={points[points.length - 1].x + 10}
                        y={points[points.length - 1].y}
                        fill={color}
                        fontSize="13"
                        fontWeight="600"
                        dominantBaseline="middle"
                      >
                        {team.player_first_name} {team.player_last_name}
                      </text>
                    )}
                  </g>
                );
              })}
              
              {/* Axis labels */}
              <text
                x={padding.left - 45}
                y={chartHeight / 2}
                fill="rgba(255, 255, 255, 0.6)"
                fontSize="12"
                fontWeight="500"
                textAnchor="middle"
                transform={`rotate(-90, ${padding.left - 45}, ${chartHeight / 2})`}
              >
                Position
              </text>
              
              <text
                x={chartWidth / 2}
                y={chartHeight - 10}
                fill="rgba(255, 255, 255, 0.6)"
                fontSize="12"
                fontWeight="500"
                textAnchor="middle"
              >
                Gameweek
              </text>
            </svg>
            
            {/* Legend */}
            <div className="mt-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              {standings.map((team, idx) => (
                <div
                  key={team.entry_id}
                  className="team-legend-item flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all hover:bg-white/5"
                  onMouseEnter={() => setHoveredTeam(team.entry_id)}
                  onMouseLeave={() => setHoveredTeam(null)}
                  style={{
                    opacity: hoveredTeam === null || hoveredTeam === team.entry_id ? 1 : 0.4,
                    transform: hoveredTeam === team.entry_id ? 'scale(1.05)' : 'scale(1)'
                  }}
                >
                  <div 
                    style={{ 
                      width: '14px', 
                      height: '14px', 
                      backgroundColor: colors[idx % colors.length],
                      borderRadius: '50%',
                      boxShadow: hoveredTeam === team.entry_id ? `0 0 8px ${colors[idx % colors.length]}` : 'none'
                    }} 
                  />
                  <span className="text-white/80 text-sm font-medium truncate">
                    {team.player_first_name} {team.player_last_name}
                  </span>
                </div>
              ))}
            </div>
            
            <p className="text-white/40 text-xs mt-6 text-center">
              üî¥ Red dots indicate time spent in danger zone (positions 7, 8, 10, 11, 12) ‚Ä¢ Hover over lines to highlight
            </p>
          </div>
        );
      };

      if (!isAuthenticated) {
        return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="glass-card rounded-2xl p-8 max-w-md w-full shadow-2xl">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">üçî</div>
                <h1 className="text-3xl font-bold text-white mb-2">
                  Spreadsheet Merchants
                </h1>
                <p className="text-white/60">FPL Draft League Tracker</p>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-white/80 text-sm font-medium mb-2">
                    Password
                  </label>
                  <div className="relative">
                    <Lock className="absolute left-3 top-3 text-white/40" size={20} />
                    <input
                      type="password"
                      value={passwordInput}
                      onChange={(e) => setPasswordInput(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      className="w-full pl-11 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-yellow-400/50 focus:ring-2 focus:ring-yellow-400/20"
                      placeholder="Enter league password"
                    />
                  </div>
                </div>
                
                <button
                  onClick={handleLogin}
                  className="w-full py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-semibold rounded-xl hover:from-yellow-300 hover:to-yellow-400 transition-all shadow-lg hover:shadow-yellow-400/50"
                >
                  Access League
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="sticky top-0 z-50 glass-card border-b border-white/10">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="text-4xl">üçî</div>
                  <div>
                    <h1 className="text-2xl font-bold text-white">
                      {config.leagueName}
                    </h1>
                    <p className="text-sm text-white/50">
                      {lastUpdated && `Updated ${lastUpdated.toLocaleTimeString()}`}
                      <span className="ml-2 text-yellow-400/60">‚Ä¢ Cached 24h</span>
                    </p>
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  <button
                    onClick={fetchLeagueData}
                    disabled={loading}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                      loading 
                        ? 'bg-white/5 text-white/40 cursor-not-allowed' 
                        : 'bg-white/10 text-white hover:bg-white/20'
                    }`}
                  >
                    <RefreshCw size={18} className={loading ? 'animate-spin' : ''} />
                    <span className="hidden sm:inline">
                      {loading ? 'Loading...' : 'Refresh'}
                    </span>
                  </button>
                  
                  <button 
                    onClick={() => setShowConfig(true)}
                    className="flex items-center gap-2 px-4 py-2 rounded-lg font-medium bg-white/10 text-white hover:bg-white/20 transition-all"
                  >
                    <Settings size={18} />
                    <span className="hidden sm:inline">Settings</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-6 py-8 space-y-8">
            {error && (
              <div className="glass-card rounded-xl p-4 border-l-4 border-red-500">
                <p className="text-red-400 font-medium">Error: {error}</p>
              </div>
            )}

            {/* Position History */}
            {positionHistory.length > 0 && (
              <div className="glass-card rounded-2xl p-8 fade-in">
                <div className="flex items-center gap-3 mb-6">
                  <TrendingUp size={24} className="text-yellow-400" />
                  <h2 className="text-2xl font-bold text-white">
                    Position History
                  </h2>
                </div>
                
                <PositionChart />
              </div>
            )}

            {/* Standings Table */}
            {standings.length > 0 && (
              <div className="glass-card rounded-2xl p-8 fade-in">
                <h2 className="text-2xl font-bold text-white mb-6">
                  League Standings
                </h2>
                
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-white/10">
                        <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Rank</th>
                        <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Manager</th>
                        <th className="text-left py-3 px-4 text-white/60 font-medium text-sm">Team</th>
                        <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Points</th>
                        <th className="text-right py-3 px-4 text-white/60 font-medium text-sm">Punishment</th>
                      </tr>
                    </thead>
                    <tbody>
                      {standings.map((team, idx) => {
                        const isPunishment = team.rank === 1 || team.rank >= 7;
                        const punishmentText = team.rank === 1 
                          ? '$200 merch (paid by others)' 
                          : team.rank >= 7 
                          ? `${8 + (team.rank - 7) * 2}hrs at McDonald's` 
                          : '-';
                        
                        return (
                          <tr 
                            key={team.entry_id}
                            className={`border-b border-white/5 transition-colors hover:bg-white/5 ${
                              isPunishment ? 'bg-yellow-400/5' : ''
                            }`}
                          >
                            <td className="py-4 px-4">
                              <div className="flex items-center gap-2">
                                <span className={`text-lg font-bold ${
                                  team.rank === 1 ? 'text-yellow-400' : 'text-white'
                                }`}>
                                  {team.rank}
                                </span>
                                {team.rank === 1 && <span className="text-xl">üèÜ</span>}
                                {isPunishment && team.rank !== 1 && <span className="text-xl">üçü</span>}
                              </div>
                            </td>
                            <td className="py-4 px-4">
                              <span className="text-white font-medium">
                                {team.player_first_name} {team.player_last_name}
                              </span>
                            </td>
                            <td className="py-4 px-4">
                              <span className="text-white/60">
                                {team.entry_name}
                              </span>
                            </td>
                            <td className="py-4 px-4 text-right">
                              <span className="text-white font-semibold">
                                {team.points_for || team.total || 0}
                              </span>
                            </td>
                            <td className="py-4 px-4 text-right">
                              <span className={isPunishment ? 'text-yellow-400 font-medium' : 'text-white/40'}>
                                {punishmentText}
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Transfer Analysis */}
            {transferAnalysis && (
              <div className="glass-card rounded-2xl p-8 fade-in">
                <h2 className="text-2xl font-bold text-white mb-6">
                  Transfer Analysis
                </h2>
                
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <h3 className="text-lg font-semibold text-white/80 mb-4">Most Active</h3>
                    <div className="space-y-2">
                      {transferAnalysis.byTotal.slice(0, 5).map((team, idx) => (
                        <div key={idx} className="flex items-center justify-between p-3 rounded-lg bg-white/5">
                          <span className="text-white font-medium">{team.player_name}</span>
                          <span className="text-yellow-400 font-semibold">{team.transferCount} transfers</span>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  <div>
                    <h3 className="text-lg font-semibold text-white/80 mb-4">Best Decision Making</h3>
                    <div className="space-y-2">
                      {transferAnalysis.byAverage.slice(0, 5).map((team, idx) => (
                        <div key={idx} className="flex items-center justify-between p-3 rounded-lg bg-white/5">
                          <span className="text-white font-medium">{team.player_name}</span>
                          <span className="text-green-400 font-semibold">
                            {team.avgImpact >= 0 ? '+' : ''}{Math.round(team.avgImpact)} avg
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {analysisLoading && (
              <div className="glass-card rounded-2xl p-8 text-center">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400 mb-4"></div>
                <p className="text-white/60">{analysisProgress}</p>
              </div>
            )}
          </div>

          {/* Settings Modal */}
          {showConfig && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
              <div className="glass-card rounded-2xl p-8 max-w-md w-full shadow-2xl">
                <h2 className="text-2xl font-bold text-white mb-6">Settings</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-white/80 text-sm font-medium mb-2">
                      League ID
                    </label>
                    <input
                      type="text"
                      value={config.leagueId}
                      onChange={(e) => setConfig({...config, leagueId: e.target.value})}
                      className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-yellow-400/50"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-white/80 text-sm font-medium mb-2">
                      Your Team ID
                    </label>
                    <input
                      type="text"
                      value={config.userTeamId}
                      onChange={(e) => setConfig({...config, userTeamId: e.target.value})}
                      className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-yellow-400/50"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-white/80 text-sm font-medium mb-2">
                      League Name
                    </label>
                    <input
                      type="text"
                      value={config.leagueName}
                      onChange={(e) => setConfig({...config, leagueName: e.target.value})}
                      className="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-yellow-400/50"
                    />
                  </div>
                </div>
                
                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => {
                      localStorage.setItem('fpl-config', JSON.stringify(config));
                      setShowConfig(false);
                      if (config.leagueId) fetchLeagueData();
                    }}
                    className="flex-1 py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-semibold rounded-xl hover:from-yellow-300 hover:to-yellow-400 transition-all"
                  >
                    Save & Refresh
                  </button>
                  <button 
                    onClick={() => setShowConfig(false)}
                    className="px-6 py-3 bg-white/10 text-white font-semibold rounded-xl hover:bg-white/20 transition-all"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
