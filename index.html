<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spreadsheet Merchants 3.0 - FPL Draft Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Lucide icons as simple components
    const Lock = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
    );
    
    const Settings = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/>
      </svg>
    );
    
    const RefreshCw = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
      </svg>
    );
    
    const Users = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    );
    
    const Trophy = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
        <path d="M4 22h16"/>
        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
      </svg>
    );
    
    const History = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 3v5h5"/>
        <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>
        <path d="M12 7v5l4 2"/>
      </svg>
    );
    
    const TrendingUp = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
        <polyline points="17 6 23 6 23 12"/>
      </svg>
    );
    
    const TrendingDown = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
        <polyline points="17 18 23 18 23 12"/>
      </svg>
    );
    
    const AlertCircle = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}>
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    );

    function FPLDraftTracker() {
      const [config, setConfig] = useState({
        leagueId: "81877",
        leagueName: "Spreadsheet Merchants 3.0",
        password: "merchants2026",
      });

      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [passwordInput, setPasswordInput] = useState('');
      const [showConfig, setShowConfig] = useState(false);
      const [leagueData, setLeagueData] = useState(null);
      const [standings, setStandings] = useState([]);
      const [waivers, setWaivers] = useState([]);
      const [allTransactions, setAllTransactions] = useState([]);
      const [transferAnalysis, setTransferAnalysis] = useState(null);
      const [analysisLoading, setAnalysisLoading] = useState(false);
      const [analysisProgress, setAnalysisProgress] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);
      
      const [waiverForm, setWaiverForm] = useState({
        manager: '',
        playerOut: '',
        playerIn: '',
        gameweek: '',
      });

      useEffect(() => {
        const authStatus = localStorage.getItem('fpl-draft-auth');
        if (authStatus === 'true') {
          setIsAuthenticated(true);
        }
      }, []);

      const handlePasswordSubmit = (e) => {
        e.preventDefault();
        if (passwordInput === config.password) {
          setIsAuthenticated(true);
          localStorage.setItem('fpl-draft-auth', 'true');
          setPasswordInput('');
        } else {
          alert('Incorrect password!');
          setPasswordInput('');
        }
      };

      const fetchLeagueData = async () => {
        if (!config.leagueId) {
          setError('Please configure your League ID in the settings');
          return;
        }

        setLoading(true);
        setError(null);

        try {
          const apiBase = '/.netlify/functions/fpl-proxy?endpoint=';
          
          const entryResponse = await fetch(`${apiBase}/api/entry/${config.leagueId}/public`);
          if (!entryResponse.ok) {
            const errorData = await entryResponse.json();
            throw new Error(`Failed to fetch entry data: ${errorData.error || entryResponse.status}`);
          }
          const entryData = await entryResponse.json();
          
          console.log('Entry data:', entryData);
          
          // Extract league ID from entry data - it's in league_set array
          const actualLeagueId = entryData.entry?.league_set?.[0] || entryData.league_set?.[0];
          
          if (!actualLeagueId) {
            throw new Error('Could not find league ID in entry data. Data: ' + JSON.stringify(entryData));
          }
          
          console.log('Found league ID:', actualLeagueId);
          
          const leagueResponse = await fetch(`${apiBase}/api/league/${actualLeagueId}/details`);
          if (!leagueResponse.ok) {
            const errorData = await leagueResponse.json();
            throw new Error(`Failed to fetch league details: ${errorData.error || leagueResponse.status}`);
          }
          const league = await leagueResponse.json();
          
          console.log('League data:', league);
          setLeagueData(league);

          // Match standings with league_entries to get full team info
          if (league.standings && league.league_entries) {
            const standingsWithDetails = league.standings.map(standing => {
              // Find the matching league entry
              const entry = league.league_entries.find(e => e.id === standing.league_entry);
              return {
                ...standing,
                entry_id: entry?.entry_id,
                entry_name: entry?.entry_name || `${entry?.player_first_name || ''} ${entry?.player_last_name || ''}`.trim(),
                player_name: `${entry?.player_first_name || ''} ${entry?.player_last_name || ''}`.trim(),
              };
            });
            // Sort by rank (already sorted, but just to be sure)
            setStandings(standingsWithDetails.sort((a, b) => a.rank - b.rank));
          } else if (league.league_entries) {
            // Fallback if standings don't exist
            const standingsWithPoints = league.league_entries.map(entry => ({
              ...entry,
              total: entry.total || 0,
              event_total: entry.event_total || 0,
              entry_name: entry.entry_name || `${entry.player_first_name || ''} ${entry.player_last_name || ''}`.trim()
            }));
            setStandings(standingsWithPoints.sort((a, b) => (b.total || 0) - (a.total || 0)));
          }

          // Fetch all team transactions for waiver analysis
          console.log('Fetching transactions for all teams...');
          if (league.league_entries) {
            await fetchAllTransactions(league.league_entries, apiBase, league);
          }

          setLastUpdated(new Date());
          loadWaivers();
        } catch (err) {
          setError(err.message);
          console.error('Error fetching data:', err);
        } finally {
          setLoading(false);
        }
      };

      const fetchAllTransactions = async (leagueEntries, apiBase, league) => {
        const transactionsData = [];
        
        try {
          // Get league ID from the passed league data
          const leagueId = league?.league?.id;
          console.log('League data available:', league);
          console.log('Extracted league ID:', leagueId);
          
          if (!leagueId) {
            console.log('ERROR: No league ID found in league');
            console.log('Full league object:', JSON.stringify(league));
            return;
          }
          
          console.log(`Fetching all transactions for league ${leagueId}...`);
          const transUrl = `${apiBase}/api/draft/league/${leagueId}/transactions`;
          console.log('Fetching from URL:', transUrl);
          
          const transResponse = await fetch(transUrl);
          console.log('Transaction response status:', transResponse.status);
          
          if (transResponse.ok) {
            const transactions = await transResponse.json();
            console.log('Raw league transactions response:', transactions);
            console.log('Transaction keys:', Object.keys(transactions));
            
            // Try different possible structures
            let transactionList = transactions.transactions || 
                                 transactions.results || 
                                 transactions.waivers ||
                                 (Array.isArray(transactions) ? transactions : []);
            
            console.log('Transaction list type:', typeof transactionList);
            console.log('Is array?', Array.isArray(transactionList));
            console.log('Transaction list length:', transactionList?.length);
            console.log('First transaction:', transactionList?.[0]);
            
            if (Array.isArray(transactionList) && transactionList.length > 0) {
              console.log(`Found ${transactionList.length} transactions for entire league`);
              
              // Match each transaction to a team name
              transactionList.forEach(t => {
                const entry = leagueEntries.find(e => e.entry_id === t.entry);
                transactionsData.push({
                  ...t,
                  team_name: entry?.entry_name || 'Unknown Team',
                  team_id: t.entry
                });
              });
            } else {
              console.log('WARNING: No transactions found in response or not an array');
            }
          } else {
            console.log(`ERROR: Failed to fetch league transactions: ${transResponse.status}`);
            const errorText = await transResponse.text();
            console.log('Error response:', errorText);
          }
        } catch (e) {
          console.log('ERROR: Exception fetching league transactions:', e);
          console.error(e);
        }
        
        console.log('Final transactions collected:', transactionsData.length, 'transactions');
        console.log('Sample transactions:', transactionsData.slice(0, 3));
        setAllTransactions(transactionsData);
        
        // After fetching transactions, check cache and analyze if needed
        if (transactionsData.length > 0) {
          await analyzeTransfersWithCache(transactionsData, apiBase);
        } else {
          console.log('No transactions to analyze - skipping transfer analysis');
        }
      };

      const analyzeTransfersWithCache = async (transactions, apiBase) => {
        try {
          // Check if we have cached analysis in localStorage
          const cached = localStorage.getItem('transfer-analysis-cache');
          
          if (cached) {
            const cachedData = JSON.parse(cached);
            // Check if cache is still valid (same gameweek and less than 1 hour old)
            const currentGW = leagueData?.current_event || 1;
            if (cachedData.gameweek === currentGW && cachedData.timestamp > Date.now() - 3600000) {
              console.log('Using cached transfer analysis');
              setTransferAnalysis(cachedData.analysis);
              return;
            }
          }
          
          // No valid cache - run analysis
          console.log('Running fresh transfer analysis...');
          await runTransferAnalysis(transactions, apiBase);
        } catch (err) {
          console.error('Cache check failed, running fresh analysis:', err);
          await runTransferAnalysis(transactions, apiBase);
        }
      };

      const runTransferAnalysis = async (transactions, apiBase) => {
        setAnalysisLoading(true);
        setAnalysisProgress('Step 1/4: Fetching player data...');
        
        try {
          // Step 1: Get all player data
          const bootstrapResponse = await fetch(`${apiBase}/api/bootstrap-static`);
          if (!bootstrapResponse.ok) throw new Error('Failed to fetch player data');
          const bootstrap = await bootstrapResponse.json();
          const players = bootstrap.elements || [];
          
          // Create player lookup
          const playerLookup = {};
          players.forEach(p => {
            playerLookup[p.id] = {
              name: p.web_name,
              team: p.team,
              position: p.element_type
            };
          });
          
          setAnalysisProgress('Step 2/4: Fetching gameweek data...');
          
          // Step 2: Get current gameweek from league data or bootstrap
          let currentGW = 1;
          
          // Try to get from league standings data first (most reliable)
          if (standings && standings.length > 0 && standings[0].event_total !== undefined) {
            // Find the highest gameweek from transactions
            const maxTransactionGW = Math.max(...transactions.map(t => t.event || 0));
            currentGW = Math.max(maxTransactionGW, 1);
          }
          
          // Fallback to bootstrap data
          if (currentGW === 1 && bootstrap.events && Array.isArray(bootstrap.events)) {
            const finishedEvents = bootstrap.events.filter(e => e.finished);
            if (finishedEvents.length > 0) {
              currentGW = Math.max(...finishedEvents.map(e => e.id));
            }
          }
          
          // Fallback to direct properties
          if (currentGW === 1) {
            currentGW = bootstrap.current_event || leagueData?.current_event || 22; // Default to 22 if nothing works
          }
          
          console.log('Current gameweek:', currentGW);
          
          // Step 3: Fetch player points for each completed gameweek
          setAnalysisProgress(`Step 3/4: Analyzing ${currentGW} gameweeks...`);
          const playerPoints = {}; // { player_id: { gw1: points, gw2: points, ... } }
          
          for (let gw = 1; gw <= currentGW; gw++) {
            try {
              const liveResponse = await fetch(`${apiBase}/api/event/${gw}/live`);
              if (liveResponse.ok) {
                const liveData = await liveResponse.json();
                
                // Handle different API response structures
                const elements = liveData.elements || liveData;
                
                if (Array.isArray(elements)) {
                  elements.forEach(el => {
                    if (!playerPoints[el.id]) playerPoints[el.id] = {};
                    playerPoints[el.id][gw] = el.stats?.total_points || 0;
                  });
                } else if (typeof elements === 'object') {
                  // Elements might be an object with player IDs as keys
                  Object.keys(elements).forEach(id => {
                    const el = elements[id];
                    if (!playerPoints[id]) playerPoints[id] = {};
                    playerPoints[id][gw] = el.stats?.total_points || 0;
                  });
                }
              }
            } catch (e) {
              console.log(`Could not fetch GW${gw} data:`, e);
            }
          }
          
          setAnalysisProgress('Step 4/4: Calculating transfer values...');
          
          // Step 4: Analyze each transfer
          const transferResults = [];
          
          transactions.forEach(trans => {
            // Only process accepted waivers (not free agents and not denied)
            if (trans.kind !== 'w' || trans.result !== 'a' || !trans.element_in || !trans.element_out) return;
            
            const gwMade = trans.event;
            const playerIn = playerLookup[trans.element_in];
            const playerOut = playerLookup[trans.element_out];
            
            if (!playerIn || !playerOut) return;
            
            // Find when this ownership period ended (next transfer or season end)
            let gwEnd = currentGW;
            const nextTransfer = transactions.find(t => 
              t.team_id === trans.team_id && 
              t.event > gwMade &&
              (t.element_out === trans.element_in || t.element_in === trans.element_out)
            );
            if (nextTransfer) gwEnd = nextTransfer.event - 1;
            
            // Calculate points during ownership period
            let pointsIn = 0;
            let pointsOut = 0;
            let gwCount = 0;
            
            for (let gw = gwMade; gw <= gwEnd; gw++) {
              pointsIn += playerPoints[trans.element_in]?.[gw] || 0;
              pointsOut += playerPoints[trans.element_out]?.[gw] || 0;
              gwCount++;
            }
            
            const netPoints = pointsIn - pointsOut;
            const perGW = gwCount > 0 ? netPoints / gwCount : 0;
            
            transferResults.push({
              team_name: trans.team_name,
              team_id: trans.team_id,
              gameweek: gwMade,
              player_in: playerIn.name,
              player_out: playerOut.name,
              points_in: pointsIn,
              points_out: pointsOut,
              net_points: netPoints,
              per_gw: perGW,
              gw_count: gwCount,
              gw_start: gwMade,
              gw_end: gwEnd
            });
          });
          
          // Sort for leaderboards
          const bestTotal = [...transferResults].sort((a, b) => b.net_points - a.net_points).slice(0, 10);
          const worstTotal = [...transferResults].sort((a, b) => a.net_points - b.net_points).slice(0, 10);
          const bestPerGW = [...transferResults].sort((a, b) => b.per_gw - a.per_gw).slice(0, 10);
          const worstPerGW = [...transferResults].sort((a, b) => a.per_gw - b.per_gw).slice(0, 10);
          
          const analysis = {
            bestTotal,
            worstTotal,
            bestPerGW,
            worstPerGW,
            allTransfers: transferResults
          };
          
          setTransferAnalysis(analysis);
          
          // Cache the results in localStorage
          try {
            localStorage.setItem('transfer-analysis-cache', JSON.stringify({
              gameweek: currentGW,
              timestamp: Date.now(),
              analysis
            }));
            console.log('Analysis cached successfully');
          } catch (e) {
            console.log('Failed to cache analysis:', e);
          }
          
          setAnalysisProgress('Complete! üçî');
        } catch (err) {
          console.error('Analysis failed:', err);
          setError('Failed to analyze transfers: ' + err.message);
        } finally {
          setAnalysisLoading(false);
        }
      };

      const loadWaivers = async () => {
        try {
          const result = localStorage.getItem('draft-waivers');
          if (result) {
            setWaivers(JSON.parse(result));
          }
        } catch (err) {
          console.log('No previous waivers found');
        }
      };

      const saveWaivers = async (newWaivers) => {
        try {
          localStorage.setItem('draft-waivers', JSON.stringify(newWaivers));
          setWaivers(newWaivers);
        } catch (err) {
          console.error('Error saving waivers:', err);
        }
      };

      const addWaiver = async (managerName, playerOut, playerIn, gameweek) => {
        const newWaiver = {
          id: Date.now(),
          managerName,
          playerOut,
          playerIn,
          gameweek,
          date: new Date().toISOString(),
        };
        const updatedWaivers = [newWaiver, ...waivers];
        await saveWaivers(updatedWaivers);
      };

      const deleteWaiver = async (id) => {
        const updatedWaivers = waivers.filter(w => w.id !== id);
        await saveWaivers(updatedWaivers);
      };

      if (!isAuthenticated) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-red-900 via-yellow-600 to-red-800 flex items-center justify-center p-5">
            <div className="bg-gradient-to-br from-red-700 to-yellow-500 p-16 rounded-3xl border-4 border-yellow-400 shadow-2xl max-w-md w-full text-center">
              <div className="text-7xl mb-5">üçî</div>
              <Lock size={64} className="text-yellow-300 mx-auto mb-5" />
              <h1 className="text-yellow-300 text-5xl font-black mb-3">FPL DRAFT</h1>
              <p className="text-yellow-100 mb-2 text-2xl font-bold">Spreadsheet Merchants 3.0</p>
              <p className="text-red-900 mb-10 font-bold">üçü McDonald's Punishment League üçü</p>
              <form onSubmit={handlePasswordSubmit}>
                <input
                  type="password"
                  value={passwordInput}
                  onChange={(e) => setPasswordInput(e.target.value)}
                  placeholder="Enter password"
                  className="w-full p-4 mb-5 bg-red-900 border-2 border-yellow-400 rounded-xl text-yellow-100 text-lg placeholder-yellow-300"
                  autoFocus
                />
                <button type="submit" className="w-full p-4 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-xl text-red-900 font-bold text-lg hover:scale-105 transition-transform shadow-lg">
                  Enter The Golden Arches
                </button>
              </form>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-red-900 via-yellow-600 to-red-800 p-5">
          {showConfig && (
            <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-5">
              <div className="bg-gradient-to-br from-gray-900 to-blue-900 p-10 rounded-2xl max-w-2xl w-full border-2 border-green-400 shadow-2xl">
                <h2 className="text-green-400 text-3xl font-bold mb-8">‚öôÔ∏è Configuration</h2>
                
                <div className="mb-5">
                  <label className="text-white block mb-2 font-semibold">League ID</label>
                  <input
                    type="text"
                    value={config.leagueId || ''}
                    onChange={(e) => setConfig({ ...config, leagueId: e.target.value })}
                    placeholder="Enter your FPL Draft League ID"
                    className="w-full p-3 bg-gray-950 border-2 border-green-400 rounded-lg text-white"
                  />
                  <p className="text-gray-500 text-xs mt-2">This is your team entry ID (81877)</p>
                </div>

                <div className="mb-5">
                  <label className="text-white block mb-2 font-semibold">League Name</label>
                  <input
                    type="text"
                    value={config.leagueName}
                    onChange={(e) => setConfig({ ...config, leagueName: e.target.value })}
                    className="w-full p-3 bg-gray-950 border-2 border-green-400 rounded-lg text-white"
                  />
                </div>

                <div className="mb-8">
                  <label className="text-white block mb-2 font-semibold">Password</label>
                  <input
                    type="password"
                    value={config.password}
                    onChange={(e) => setConfig({ ...config, password: e.target.value })}
                    className="w-full p-3 bg-gray-950 border-2 border-green-400 rounded-lg text-white"
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setShowConfig(false);
                      if (config.leagueId) fetchLeagueData();
                    }}
                    className="flex-1 p-4 bg-gradient-to-r from-green-400 to-green-500 rounded-lg text-gray-900 font-bold"
                  >
                    Save & Refresh Data
                  </button>
                  <button onClick={() => setShowConfig(false)} className="px-6 py-4 bg-gray-800 border-2 border-gray-600 rounded-lg text-white font-semibold">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}

          <div className="max-w-7xl mx-auto mb-10 bg-gradient-to-br from-red-700 to-yellow-500 p-8 rounded-3xl border-4 border-yellow-400 shadow-2xl">
            <div className="flex justify-between items-center flex-wrap gap-5">
              <div>
                <div className="text-6xl mb-2">üçî</div>
                <h1 className="text-6xl font-black text-yellow-300 mb-2" style={{textShadow: '3px 3px 0px rgba(139, 0, 0, 0.8)'}}>
                  {config.leagueName}
                </h1>
                <p className="text-yellow-100 font-bold text-lg">
                  üçü McDonald's Punishment League üçü
                </p>
                <p className="text-red-900 font-semibold">
                  {lastUpdated && `Last updated: ${lastUpdated.toLocaleTimeString()}`}
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={fetchLeagueData}
                  disabled={loading}
                  className={`px-6 py-4 rounded-xl font-bold flex items-center gap-2 border-2 ${loading ? 'bg-red-900 border-yellow-600' : 'bg-yellow-400 text-red-900 border-yellow-500 hover:bg-yellow-300'} shadow-lg`}
                >
                  <RefreshCw size={18} className={loading ? 'animate-spin' : ''} />
                  {loading ? 'Loading...' : 'üîÑ Refresh'}
                </button>
                <button onClick={() => setShowConfig(true)} className="px-6 py-4 bg-red-800 border-2 border-yellow-400 rounded-xl text-yellow-300 font-semibold flex items-center gap-2 hover:bg-red-700">
                  <Settings size={18} />
                  Settings
                </button>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto">
            {error && (
              <div className="bg-red-500 bg-opacity-10 border-2 border-red-500 rounded-xl p-5 mb-8 flex items-center gap-3">
                <AlertCircle size={24} className="text-red-500" />
                <div>
                  <h3 className="text-red-500">Error</h3>
                  <p className="text-white">{error}</p>
                </div>
              </div>
            )}

            {!config.leagueId && (
              <div className="bg-gradient-to-br from-gray-900 to-blue-900 border-2 border-green-400 rounded-2xl p-10 mb-8 text-center">
                <Trophy size={64} className="text-green-400 mx-auto mb-5" />
                <h2 className="text-green-400 text-4xl mb-4 font-bold">Welcome!</h2>
                <p className="text-gray-300 text-lg mb-8">Click Settings to configure your League ID</p>
                <button onClick={() => setShowConfig(true)} className="px-8 py-4 bg-gradient-to-r from-green-400 to-green-500 rounded-xl text-gray-900 font-bold text-lg">
                  Configure Now
                </button>
              </div>
            )}

            {standings.length > 0 && (
              <>
                {/* McDonald's Punishment Tracker */}
                <div className="bg-gradient-to-br from-red-700 to-yellow-500 p-8 rounded-3xl border-4 border-yellow-400 mb-8 shadow-2xl">
                  <h2 className="text-4xl font-black text-yellow-300 mb-6 flex items-center gap-3" style={{textShadow: '2px 2px 0px rgba(139, 0, 0, 0.8)'}}>
                    üçî McDonald's Punishment Tracker
                  </h2>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    {/* Winner Section */}
                    <div className="bg-yellow-400 p-6 rounded-2xl border-4 border-yellow-300 shadow-lg">
                      <h3 className="text-2xl font-black text-red-900 mb-4">üèÜ CHAMPION</h3>
                      {standings[0] && (
                        <div className="text-center">
                          <p className="text-3xl font-black text-red-900 mb-2">{standings[0].entry_name}</p>
                          <p className="text-xl font-bold text-red-800">Wins $200 Merch!</p>
                          <p className="text-sm text-red-700 mt-2">Paid by 2nd-12th place ($18.18 each)</p>
                        </div>
                      )}
                    </div>

                    {/* Safe Zone */}
                    <div className="bg-green-500 p-6 rounded-2xl border-4 border-green-400 shadow-lg">
                      <h3 className="text-2xl font-black text-white mb-4">üòå SAFE ZONE</h3>
                      <div className="text-center">
                        <p className="text-lg font-bold text-white">2nd - 6th Place</p>
                        <p className="text-3xl my-2">‚úÖ</p>
                        <p className="text-sm text-white">No punishment!</p>
                        <div className="mt-3 text-lg font-bold text-white">
                          <p>9th Place</p>
                          <p className="text-sm">The Lucky Escape! üçÄ</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Punishment Table */}
                  <div className="bg-red-900 p-6 rounded-2xl border-4 border-red-700">
                    <h3 className="text-2xl font-black text-yellow-300 mb-4">‚ö†Ô∏è THE DANGER ZONE ‚ö†Ô∏è</h3>
                    <div className="space-y-3">
                      {[
                        { rank: 7, hours: 8 },
                        { rank: 8, hours: 10 },
                        { rank: 10, hours: 14 },
                        { rank: 11, hours: 16 },
                        { rank: 12, hours: 18 }
                      ].map(punishment => {
                        const team = standings.find(s => s.rank === punishment.rank);
                        return team ? (
                          <div key={punishment.rank} className={`bg-red-800 p-4 rounded-xl border-2 ${punishment.rank === 12 ? 'border-yellow-400 shadow-lg' : 'border-red-600'}`}>
                            <div className="flex justify-between items-center flex-wrap gap-3">
                              <div className="flex items-center gap-3">
                                <span className="text-3xl">{punishment.rank === 12 ? 'üíÄ' : 'üçî'}</span>
                                <div>
                                  <p className="text-lg font-bold text-yellow-300">{punishment.rank}th Place: {team.entry_name}</p>
                                  <p className="text-sm text-yellow-100">{team.total} points</p>
                                </div>
                              </div>
                              <div className="text-right">
                                <p className="text-3xl font-black text-yellow-400">{punishment.hours} hrs</p>
                                <p className="text-xs text-yellow-200">in McDonald's</p>
                              </div>
                            </div>
                            {/* French fry progress bar */}
                            <div className="mt-3 bg-red-950 rounded-full h-3 overflow-hidden">
                              <div 
                                className="bg-yellow-400 h-full rounded-full transition-all"
                                style={{width: `${(punishment.hours / 18) * 100}%`}}
                              ></div>
                            </div>
                          </div>
                        ) : null;
                      })}
                    </div>
                  </div>
                </div>

                {/* League Standings */}
                <div className="bg-gradient-to-br from-red-700 to-yellow-500 p-8 rounded-3xl border-4 border-yellow-400 mb-8 shadow-2xl">
                <h2 className="text-3xl font-bold text-yellow-300 mb-6 flex items-center gap-3">
                  <Users size={28} />
                  Full League Standings
                </h2>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b-4 border-yellow-400">
                        <th className="p-4 text-left text-yellow-300 font-bold">Rank</th>
                        <th className="p-4 text-left text-yellow-300 font-bold">Team</th>
                        <th className="p-4 text-left text-yellow-300 font-bold">Points</th>
                        <th className="p-4 text-left text-yellow-300 font-bold">This GW</th>
                        <th className="p-4 text-left text-yellow-300 font-bold">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {standings.map((team, idx) => {
                        let status = '';
                        let statusColor = '';
                        if (team.rank === 1) {
                          status = 'üèÜ WINNER';
                          statusColor = 'text-yellow-300 font-black';
                        } else if (team.rank >= 2 && team.rank <= 6) {
                          status = '‚úÖ Safe';
                          statusColor = 'text-green-300';
                        } else if (team.rank === 9) {
                          status = 'üçÄ Lucky!';
                          statusColor = 'text-green-300';
                        } else if (team.rank === 7) {
                          status = 'üçî 8hrs';
                          statusColor = 'text-orange-300';
                        } else if (team.rank === 8) {
                          status = 'üçî 10hrs';
                          statusColor = 'text-orange-300';
                        } else if (team.rank === 10) {
                          status = '‚ö†Ô∏è 14hrs';
                          statusColor = 'text-red-300';
                        } else if (team.rank === 11) {
                          status = 'üíÄ 16hrs';
                          statusColor = 'text-red-400';
                        } else if (team.rank === 12) {
                          status = 'üíÄ 18hrs';
                          statusColor = 'text-red-500 font-black';
                        }
                        
                        return (
                          <tr key={idx} className={`border-b-2 border-yellow-600 ${team.rank === 1 ? 'bg-yellow-400 bg-opacity-20' : team.rank === 12 ? 'bg-red-900 bg-opacity-50' : ''}`}>
                            <td className="p-4 text-yellow-100 font-semibold text-lg">
                              {team.rank}
                              {team.rank === 1 && <Trophy size={16} className="text-yellow-400 inline ml-2" />}
                              {team.rank === 12 && <span className="ml-2">üíÄ</span>}
                            </td>
                            <td className="p-4 text-yellow-100 font-bold">{team.entry_name}</td>
                            <td className="p-4 text-yellow-300 font-bold text-xl">{team.total || 0}</td>
                            <td className="p-4">
                              <span className="px-3 py-1 bg-yellow-400 bg-opacity-30 rounded-full text-yellow-200 text-sm font-semibold">
                                {team.event_total || 0} pts
                              </span>
                            </td>
                            <td className={`p-4 font-bold ${statusColor}`}>
                              {status}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
              </>
            )}

            <div className="bg-gradient-to-br from-red-700 to-yellow-500 p-8 rounded-3xl border-4 border-yellow-400 mb-8 shadow-2xl">
              <h3 className="text-yellow-300 mb-5 text-2xl font-black">üîÑ Add Waiver Transaction</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  type="text"
                  placeholder="Manager Name"
                  value={waiverForm.manager}
                  onChange={(e) => setWaiverForm({ ...waiverForm, manager: e.target.value })}
                  className="p-3 bg-red-900 border-2 border-yellow-400 rounded-lg text-yellow-100 placeholder-yellow-300"
                />
                <input
                  type="text"
                  placeholder="Gameweek (e.g., GW23)"
                  value={waiverForm.gameweek}
                  onChange={(e) => setWaiverForm({ ...waiverForm, gameweek: e.target.value })}
                  className="p-3 bg-red-900 border-2 border-yellow-400 rounded-lg text-yellow-100 placeholder-yellow-300"
                />
                <input
                  type="text"
                  placeholder="Player OUT"
                  value={waiverForm.playerOut}
                  onChange={(e) => setWaiverForm({ ...waiverForm, playerOut: e.target.value })}
                  className="p-3 bg-red-900 border-2 border-yellow-400 rounded-lg text-yellow-100 placeholder-yellow-300"
                />
                <input
                  type="text"
                  placeholder="Player IN"
                  value={waiverForm.playerIn}
                  onChange={(e) => setWaiverForm({ ...waiverForm, playerIn: e.target.value })}
                  className="p-3 bg-red-900 border-2 border-yellow-400 rounded-lg text-yellow-100 placeholder-yellow-300"
                />
              </div>
              <button
                onClick={() => {
                  if (waiverForm.manager && waiverForm.playerOut && waiverForm.playerIn && waiverForm.gameweek) {
                    addWaiver(waiverForm.manager, waiverForm.playerOut, waiverForm.playerIn, waiverForm.gameweek);
                    setWaiverForm({ manager: '', playerOut: '', playerIn: '', gameweek: '' });
                  } else {
                    alert('Please fill in all fields');
                  }
                }}
                className="mt-4 w-full p-3 bg-yellow-400 hover:bg-yellow-300 rounded-lg text-red-900 font-black text-lg shadow-lg"
              >
                Add Waiver üçî
              </button>
            </div>

            {waivers.length > 0 && (
              <div className="bg-gradient-to-br from-red-700 to-yellow-500 p-8 rounded-3xl border-4 border-yellow-400 shadow-2xl">
                <h2 className="text-3xl font-bold text-yellow-300 mb-6 flex items-center gap-3">
                  <History size={28} />
                  Waiver History üçü
                </h2>
                <div className="space-y-4">
                  {waivers.map((waiver) => (
                    <div key={waiver.id} className="bg-red-900 p-5 rounded-xl border-2 border-yellow-400 flex justify-between items-center flex-wrap gap-4">
                      <div className="flex-1">
                        <p className="text-yellow-300 font-bold mb-2">{waiver.managerName} ‚Ä¢ {waiver.gameweek}</p>
                        <div className="flex items-center gap-3 flex-wrap">
                          <span className="text-red-300 flex items-center gap-2">
                            <TrendingDown size={16} />
                            {waiver.playerOut}
                          </span>
                          <span className="text-yellow-400">‚Üí</span>
                          <span className="text-green-300 flex items-center gap-2">
                            <TrendingUp size={16} />
                            {waiver.playerIn}
                          </span>
                        </div>
                        <p className="text-yellow-200 text-xs mt-2">{new Date(waiver.date).toLocaleDateString()}</p>
                      </div>
                      <button
                        onClick={() => deleteWaiver(waiver.id)}
                        className="px-4 py-2 bg-red-800 border-2 border-red-600 rounded-lg text-red-300 text-sm font-semibold hover:bg-red-700"
                      >
                        Delete
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Transfer Analysis Loading */}
            {analysisLoading && (
              <div className="bg-gradient-to-br from-red-700 to-yellow-500 p-8 rounded-3xl border-4 border-yellow-400 shadow-2xl mt-8">
                <h2 className="text-3xl font-bold text-yellow-300 mb-6 flex items-center gap-3">
                  üîÑ Analyzing Transfers...
                </h2>
                <div className="text-center">
                  <div className="text-6xl mb-4 animate-bounce">üçî</div>
                  <p className="text-yellow-100 text-xl font-bold">{analysisProgress}</p>
                  <p className="text-yellow-200 text-sm mt-2">This may take 30-60 seconds...</p>
                </div>
              </div>
            )}

            {/* Transfer Analysis Leaderboards */}
            {transferAnalysis && !analysisLoading && (
              <div className="space-y-8 mt-8">
                {/* Best Transfers - Total Points */}
                <div className="bg-gradient-to-br from-green-700 to-green-500 p-8 rounded-3xl border-4 border-green-400 shadow-2xl">
                  <h2 className="text-3xl font-bold text-white mb-6 flex items-center gap-3">
                    üèÜ BEST TRANSFERS - Total Points
                  </h2>
                  <p className="text-green-100 mb-4">The masterstrokes that changed seasons</p>
                  <div className="space-y-3">
                    {transferAnalysis.bestTotal.map((t, idx) => (
                      <div key={idx} className="bg-green-900 bg-opacity-50 p-5 rounded-xl border-2 border-green-400">
                        <div className="flex justify-between items-start flex-wrap gap-3">
                          <div className="flex-1">
                            <p className="text-xl font-bold text-green-300">#{idx + 1} - {t.team_name}</p>
                            <p className="text-green-100 text-sm mb-2">GW{t.gameweek} (tracked {t.gw_count} gameweeks)</p>
                            <div className="flex items-center gap-2 text-white">
                              <span className="line-through text-red-300">{t.player_out}</span>
                              <span>‚Üí</span>
                              <span className="font-bold text-green-300">{t.player_in}</span>
                            </div>
                            <p className="text-sm text-green-200 mt-2">
                              {t.player_in}: {t.points_in} pts ‚Ä¢ {t.player_out}: {t.points_out} pts
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-4xl font-black text-green-300">+{t.net_points}</p>
                            <p className="text-sm text-green-200">+{t.per_gw.toFixed(1)} per GW</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Worst Transfers - Total Points */}
                <div className="bg-gradient-to-br from-red-700 to-red-500 p-8 rounded-3xl border-4 border-red-400 shadow-2xl">
                  <h2 className="text-3xl font-bold text-yellow-300 mb-6 flex items-center gap-3">
                    üíÄ WORST TRANSFERS - Total Points
                  </h2>
                  <p className="text-red-100 mb-4">The disasters that haunt your dreams</p>
                  <div className="space-y-3">
                    {transferAnalysis.worstTotal.map((t, idx) => (
                      <div key={idx} className={`bg-red-900 bg-opacity-50 p-5 rounded-xl border-2 ${idx === 0 ? 'border-yellow-400 shadow-lg' : 'border-red-400'}`}>
                        <div className="flex justify-between items-start flex-wrap gap-3">
                          <div className="flex-1">
                            <p className="text-xl font-bold text-yellow-300">#{idx + 1} - {t.team_name} {idx === 0 && 'üíÄ'}</p>
                            <p className="text-red-100 text-sm mb-2">GW{t.gameweek} (tracked {t.gw_count} gameweeks)</p>
                            <div className="flex items-center gap-2 text-white">
                              <span className="font-bold text-yellow-300">{t.player_out}</span>
                              <span>‚Üí</span>
                              <span className="line-through text-red-300">{t.player_in}</span>
                            </div>
                            <p className="text-sm text-red-200 mt-2">
                              {t.player_in}: {t.points_in} pts ‚Ä¢ {t.player_out}: {t.points_out} pts
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-4xl font-black text-red-300">{t.net_points}</p>
                            <p className="text-sm text-red-200">{t.per_gw.toFixed(1)} per GW</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Best Transfers - Per Gameweek */}
                <div className="bg-gradient-to-br from-blue-700 to-blue-500 p-8 rounded-3xl border-4 border-blue-400 shadow-2xl">
                  <h2 className="text-3xl font-bold text-white mb-6 flex items-center gap-3">
                    üìä BEST TRANSFERS - Per Gameweek
                  </h2>
                  <p className="text-blue-100 mb-4">The smartest decisions (quality over quantity)</p>
                  <div className="space-y-3">
                    {transferAnalysis.bestPerGW.map((t, idx) => (
                      <div key={idx} className="bg-blue-900 bg-opacity-50 p-5 rounded-xl border-2 border-blue-400">
                        <div className="flex justify-between items-start flex-wrap gap-3">
                          <div className="flex-1">
                            <p className="text-xl font-bold text-blue-300">#{idx + 1} - {t.team_name}</p>
                            <p className="text-blue-100 text-sm mb-2">GW{t.gameweek} ({t.gw_count} gameweeks tracked)</p>
                            <div className="flex items-center gap-2 text-white">
                              <span className="line-through text-red-300">{t.player_out}</span>
                              <span>‚Üí</span>
                              <span className="font-bold text-blue-300">{t.player_in}</span>
                            </div>
                            <p className="text-sm text-blue-200 mt-2">
                              Total impact: +{t.net_points} points
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-4xl font-black text-blue-300">+{t.per_gw.toFixed(1)}</p>
                            <p className="text-sm text-blue-200">per GW</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Worst Transfers - Per Gameweek */}
                <div className="bg-gradient-to-br from-purple-700 to-purple-500 p-8 rounded-3xl border-4 border-purple-400 shadow-2xl">
                  <h2 className="text-3xl font-bold text-yellow-300 mb-6 flex items-center gap-3">
                    ü§¶ WORST TRANSFERS - Per Gameweek
                  </h2>
                  <p className="text-purple-100 mb-4">The dumbest decisions (efficiency of failure)</p>
                  <div className="space-y-3">
                    {transferAnalysis.worstPerGW.map((t, idx) => (
                      <div key={idx} className={`bg-purple-900 bg-opacity-50 p-5 rounded-xl border-2 ${idx === 0 ? 'border-yellow-400 shadow-lg' : 'border-purple-400'}`}>
                        <div className="flex justify-between items-start flex-wrap gap-3">
                          <div className="flex-1">
                            <p className="text-xl font-bold text-yellow-300">#{idx + 1} - {t.team_name} {idx === 0 && 'ü§°'}</p>
                            <p className="text-purple-100 text-sm mb-2">GW{t.gameweek} ({t.gw_count} gameweeks tracked)</p>
                            <div className="flex items-center gap-2 text-white">
                              <span className="font-bold text-yellow-300">{t.player_out}</span>
                              <span>‚Üí</span>
                              <span className="line-through text-red-300">{t.player_in}</span>
                            </div>
                            <p className="text-sm text-purple-200 mt-2">
                              Total damage: {t.net_points} points
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="text-4xl font-black text-purple-300">{t.per_gw.toFixed(1)}</p>
                            <p className="text-sm text-purple-200">per GW</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Summary Stats */}
                <div className="bg-gradient-to-br from-gray-700 to-gray-600 p-8 rounded-3xl border-4 border-gray-500 shadow-2xl">
                  <h2 className="text-3xl font-bold text-white mb-6">üìà Transfer Database Stats</h2>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-gray-800 p-4 rounded-xl text-center">
                      <p className="text-4xl font-black text-yellow-400">{transferAnalysis.allTransfers.length}</p>
                      <p className="text-gray-300 text-sm">Total Transfers</p>
                    </div>
                    <div className="bg-gray-800 p-4 rounded-xl text-center">
                      <p className="text-4xl font-black text-green-400">
                        {transferAnalysis.allTransfers.filter(t => t.net_points > 0).length}
                      </p>
                      <p className="text-gray-300 text-sm">Good Transfers</p>
                    </div>
                    <div className="bg-gray-800 p-4 rounded-xl text-center">
                      <p className="text-4xl font-black text-red-400">
                        {transferAnalysis.allTransfers.filter(t => t.net_points < 0).length}
                      </p>
                      <p className="text-gray-300 text-sm">Bad Transfers</p>
                    </div>
                    <div className="bg-gray-800 p-4 rounded-xl text-center">
                      <p className="text-4xl font-black text-yellow-400">
                        {(transferAnalysis.allTransfers.reduce((sum, t) => sum + Math.abs(t.net_points), 0) / transferAnalysis.allTransfers.length).toFixed(1)}
                      </p>
                      <p className="text-gray-300 text-sm">Avg Impact</p>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<FPLDraftTracker />);
  </script>
</body>
</html>
